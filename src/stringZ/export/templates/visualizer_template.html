<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>{{TITLE}}</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <style>
      :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: white;
            --bg-banner: #f8f9fa;
            --text-primary: #333;
            --text-secondary: #6c757d;
            --text-muted: #495057;
            --border-color: #dee2e6;
            --table-header-bg: #f8f9fa;
            --table-border: #dee2e6;
            --button-bg: #6c757d;
            --button-hover: #5a6268;
            --input-bg: white;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-banner: #343a40;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --text-muted: #ced4da;
            --border-color: #495057;
            --table-header-bg: #343a40;
            --table-border: #495057;
            --button-bg: #495057;
            --button-hover: #5a6268;
            --input-bg: #343a40;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            margin: 0;
            padding: 0;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .toggle-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 9999;
            padding: 8px 16px;
            background-color: var(--button-bg);
            color: white;
            border: 1px solid var(--button-bg);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .toggle-btn:hover {
            background-color: var(--button-hover);
            border-color: var(--button-hover);
        }
        
        .dark-mode-btn {
            position: fixed;
            top: 15px;
            left: 150px;
            z-index: 9999;
            padding: 8px 16px;
            background-color: var(--button-bg);
            color: white;
            border: 1px solid var(--button-bg);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .dark-mode-btn:hover {
            background-color: var(--button-hover);
            border-color: var(--button-hover);
        }
        
        #clearState {
            float: left;
            margin-right: 15px;
            margin-bottom: 15px;
            padding: 8px 16px;
            background-color: #dc3545;
            color: white;
            border: 1px solid #dc3545;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        #clearState:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        
        .container {
            padding: 70px 30px 30px 30px;
            background: var(--bg-secondary);
            margin: 0;
            min-height: 100vh;
            transition: background-color 0.3s;
        }
        
        .info-banner {
            background-color: var(--bg-banner);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 4px;
            text-align: center;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .info-banner h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .info-banner p {
            margin: 0;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        #myTable {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            transition: border-color 0.3s;
        }
        
        #myTable td {
            user-select: text;
            padding: 12px 8px;
            vertical-align: top;
            border-bottom: 1px solid var(--table-border);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        
        #myTable th {
            background-color: var(--table-header-bg);
            border-bottom: 2px solid var(--border-color);
            color: var(--text-muted);
            font-weight: 600;
            padding: 15px 8px;
            text-align: center;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        
        #myTable td:first-child {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            width: 50px;
        }
        
        #myTable td:nth-child(2) {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: left;
            max-width: 80px;
            min-width: 80px;
            width: 80px;
            white-space: normal;
            word-break: break-all;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            line-height: 1.2;
        }

        #myTable td.text-column {
            line-height: 1.4;
            max-width: 200px;
            word-wrap: break-word;
            text-align: left;
            font-weight: normal;
        }

        #myTable td.occurrences-column {
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            color: var(--text-muted);
        }

        #myTable td.state-column {
            max-width: 150px;
            text-align: center;
        }

        #myTable td.notes-column {
            max-width: 200px;
        }
        
        select.state-select {
            width: 100%;
            font-weight: 500;
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        select.state-select:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        select.state-select.pass {
            color: #28a745;
            border-color: #28a745;
        }
        
        select.state-select.fail {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .dataTables_wrapper {
            color: var(--text-primary);
        }
        
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            margin: 15px 0;
        }
        
        .dataTables_wrapper .dataTables_filter input {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 12px;
            margin-left: 8px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        .dataTables_wrapper .dataTables_length select {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            margin: 0 8px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 12px;
            margin: 0 2px;
            background-color: var(--input-bg);
            color: var(--text-primary) !important;
            transition: all 0.3s;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: var(--bg-banner);
            border-color: var(--text-secondary);
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background-color: #007bff;
            border-color: #007bff;
            color: white !important;
        }

        .copyable-cell {
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }

        .copyable-cell:hover {
            background-color: rgba(0, 123, 255, 0.1) !important;
        }

        .copy-feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .copy-feedback.show {
            opacity: 1;
        }

        .keyboard-focus {
            background-color: rgba(0, 123, 255, 0.08) !important;
            border: 2px solid #007bff !important;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2) !important;
        }

        .keyboard-focus td {
            background-color: rgba(0, 123, 255, 0.05) !important;
        }

        kbd {
            background-color: var(--button-bg);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 11px;
            font-family: monospace;
        }

        .zen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-primary);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .zen-container {
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }

        .zen-progress {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .zen-progress-bar {
            width: 200px;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            margin: 10px auto 40px;
            overflow: hidden;
        }

        .zen-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            transition: width 0.3s;
        }

        .zen-string-id {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: var(--text-secondary);
            background: var(--bg-banner);
            padding: 8px 16px;
            border-radius: 6px;
            margin-bottom: 30px;
            display: inline-block;
            cursor: pointer;
        }

        .zen-source, .zen-target, .zen-string-id {
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }

        .zen-source:hover, .zen-target:hover, .zen-string-id:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        .zen-text-pair {
            margin: 30px 0;
        }

        .zen-source, .zen-target {
            font-size: 18px;
            text-align: left;
            line-height: 1.6;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .zen-source {
            background: var(--bg-banner);
            border-left: 4px solid #007bff;
            color: var(--text-primary);
        }

        .zen-target {
            background: var(--bg-banner);
            border-left: 4px solid #28a745;
            color: var(--text-primary);
        }

        .zen-actions {
            margin: 30px 0;
        }

        .zen-btn {
            padding: 12px 24px;
            margin: 0 8px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zen-btn-pass {
            background: #28a745;
            color: white;
        }

        .zen-btn-fail {
            background: #dc3545;
            color: white;
        }

        .zen-btn-nav {
            background: var(--button-bg);
            color: white;
        }

        .zen-notes {
            width: 100%;
            max-width: 500px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            margin-top: 20px;
        }

        .zen-exit {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .zen-state-indicator {
            position: absolute;
            top: 30px;
            right: 20px;
            transform: translateY(-50%);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            z-index: 10001;
        }

        .zen-state-unreviewed {
            background: var(--border-color);
            color: var(--text-secondary);
        }

        .zen-state-pass {
            background: #28a745;
            color: white;
        }

        .zen-state-fail {
            background: #dc3545;
            color: white;
        }

        .zen-feedback {
            position: absolute;
            top: 50px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 18px;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .zen-feedback.show {
            opacity: 1;
        }

        .zen-raw-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .number-buffer-display {
            position: fixed;
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10005;
        }

        .number-buffer-display.normal {
            top: 60px;
            right: 10px;
            z-index: 9999;
        }

        .number-buffer-display.zen {
            position: absolute;
            bottom: 15px;
            right: 15px;
            z-index: 10005;
        }

        .number-buffer-display.show {
            opacity: 1;
        }

        .notes-textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s;
            min-height: 40px;
            max-height: 80px;
            resize: vertically;
            font-family: inherit;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .notes-textarea::placeholder {
            color: var(--text-secondary);
            font-style: italic;
        }

        .spaces-active {
            position: relative;
        }

        .spaces-active::before {
            content: "•";
            position: absolute;
            left: -5px;
            top: 50%;
            transform: translateY(-50%);
            color: #ffc107;
            font-weight: bold;
            font-size: 16px;
            z-index: 1;
        }

        [data-theme="dark"] .spaces-active::before {
            color: #ffd43b;
        }

        .zen-spaces-active {
            position: relative;
            border-left: 4px solid #ffc107 !important;
        }

        .zen-spaces-active::after {
            content: "SPACES";
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ffc107;
            color: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            font-family: monospace;
        }
    </style>
  </head>
  <body>
    <button class="toggle-btn" onclick="toggleData()">Show Raw</button>
    <button class="dark-mode-btn" onclick="toggleDarkMode()">🌙 Dark</button>
    <div class="container">
      <div class="info-banner">
        <h2>{{TITLE}}</h2>
        <p>📊
          <strong>{{ENTRY_COUNT}}</strong>
          strings • 🌍
          <strong>{{SOURCE_LANG}}</strong>
          →
          <strong>{{TARGET_LANG}}</strong>
          • 📝
          <strong>{{WORD_COUNT}}</strong>
          words • 🛠️ Generated by StringZ</p>
      </div>
      <button id="clearState">Clear All States</button>
      <table id="myTable" class="display" style="width:100%"></table>
    </div>
    <script>
      const config = {
            headers: {{HEADERS_JS}},
            rawData: {{RAW_DATA_JS}},
            formattedData: {{FORMATTED_DATA_JS}},
            debounceDelay: 300,
            numberInputTimeout: 3000,
            feedbackTimeout: 1500
        };

        let state = {
            showingRaw: false,
            tableData: config.formattedData,
            dataTable: null,
            currentRowIndex: 0,
            isKeyboardMode: false,
            normalHelpOpen: false,
            zenMode: false,
            zenCurrentIndex: 0,
            zenShowingRaw: false,
            zenHelpOpen: false,
            zenSpacesMode: false,
            numberBuffer: '',
            numberInputTimeout: null,
            originalZenContent: {},
            originalRowContent: {},
            currentRowSpacesMode: false
        };

        const storage = {
            getStateKey: (index) => `state_{{TITLE}}_row_${index}`,
            getNotesKey: (index) => `notes_{{TITLE}}_row_${index}`,
            getState: (index) => localStorage.getItem(storage.getStateKey(index)) || '',
            setState: (index, value) => localStorage.setItem(storage.getStateKey(index), value),
            getNotes: (index) => localStorage.getItem(storage.getNotesKey(index)) || '',
            setNotes: (index, value) => localStorage.setItem(storage.getNotesKey(index), value),
            clearState: (index) => {
                localStorage.removeItem(storage.getStateKey(index));
                localStorage.removeItem(storage.getNotesKey(index));
            }
        };

        const utils = {
            escapeHtml: (text) => text.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;'),
            
            decodeHtml: (html) => {
                const div = document.createElement('div');
                div.innerHTML = html;
                return div.textContent || div.innerText || html;
            },

            isChineseMode: () => config.headers.includes('CN') && config.headers.includes('EN') && config.headers.length >= 6,

            debounce: (func, delay) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            },

            showFeedback: (message, color = '#6c757d', duration = config.feedbackTimeout) => {
                const feedback = $(`<div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: ${color}; color: white; padding: 8px 16px; border-radius: 4px; z-index: 10000;">${message}</div>`);
                $('body').append(feedback);
                setTimeout(() => feedback.fadeOut(300, function() { $(this).remove(); }), duration);
            }
        };

        const dataRenderer = {
            generateRowWithState: (row, idx) => {
                const savedState = storage.getState(idx);
                const savedNotes = storage.getNotes(idx);
                const stateClass = savedState ? savedState.toLowerCase() : '';
                
                const selectHTML = `<select class="state-select ${stateClass}">
                    <option value="" ${savedState === '' ? 'selected' : ''}></option>
                    <option value="Pass" ${savedState === 'Pass' ? 'selected' : ''}>Pass</option>
                    <option value="Fail" ${savedState === 'Fail' ? 'selected' : ''}>Fail</option>
                </select>`;
                
                const notesHTML = `<textarea class="notes-textarea" placeholder="Personal notes..." maxlength="200" rows="2">${utils.escapeHtml(savedNotes)}</textarea>`;

                const newRow = [...row];
                const stateIndex = config.headers.indexOf('State');
                const notesIndex = config.headers.indexOf('Notes');

                if (stateIndex !== -1) newRow[stateIndex + 1] = selectHTML;
                if (notesIndex !== -1) newRow[notesIndex + 1] = notesHTML;
                
                return newRow;
            },

            renderData: (data) => {
                state.tableData = data;
                const transformed = data.map((row, idx) => {
                    const rowWithNumber = [idx + 1, ...row];
                    return dataRenderer.generateRowWithState(rowWithNumber, idx);
                });

                if (!state.dataTable) {
                    dataRenderer.initializeTable(transformed);
                } else {
                    dataRenderer.updateTable(transformed);
                }

                setTimeout(() => dataRenderer.applyColumnClasses(), 100);
            },

            initializeTable: (transformed) => {
                const columnsWithNumber = [{ title: '#' }, ...config.headers.map(h => ({ title: h }))];
                
                state.dataTable = $('#myTable').DataTable({
                    data: transformed,
                    columns: columnsWithNumber,
                    scrollX: true,
                    paging: true,
                    searching: true,
                    ordering: true,
                    deferRender: true,
                    lengthMenu: [[-1, 10, 25, 50, 100], ["All", 10, 25, 50, 100]],
                    order: [],
                    autoWidth: false,
                    columnDefs: dataRenderer.getColumnDefs()
                });

                setTimeout(() => {
                    state.dataTable.columns.adjust().draw();
                }, 50);

                dataRenderer.bindEvents();
            },

            updateTable: (transformed) => {
                const currentPage = state.dataTable.page();
                const currentLength = state.dataTable.page.len();
                state.dataTable.clear().rows.add(transformed).draw(false);
                state.dataTable.page.len(currentLength).draw();
                state.dataTable.page(currentPage).draw(false);
            },

            getColumnDefs: () => {
                const totalColumns = config.headers.length + 1;
                const defs = [
                    { targets: 0, width: "50px", className: "text-center" },
                    { targets: 1, width: "80px", className: "text-left" }
                ];

                for (let i = 2; i < totalColumns; i++) {
                    const header = config.headers[i - 1];
                    if (header === "Occurrences") {
                        defs.push({ targets: i, width: "30px", className: "text-center" });
                    } else if (header === "State") {
                        defs.push({ targets: i, width: "40px", className: "text-center", orderable: true });
                    } else if (header === "Notes") {
                        defs.push({ targets: i, width: "80px", className: "text-center" });
                    } else {
                        defs.push({ targets: i, width: "200px", className: "text-left" });
                    }
                }

                return defs;
            },

            bindEvents: () => {
                $('#myTable tbody').on('change', 'select.state-select', function() {
                    const rowIdx = state.dataTable.row($(this).closest('tr')).index();
                    const value = $(this).val();
                    storage.setState(rowIdx, value);
                    $(this).removeClass('pass fail');
                    if (value) $(this).addClass(value.toLowerCase());
                    setTimeout(progressTracker.update, 100);
                });

                const debouncedNotesSave = utils.debounce((rowIdx, value) => {
                    storage.setNotes(rowIdx, value);
                }, config.debounceDelay);

                $('#myTable tbody').on('input', 'textarea.notes-textarea', function() {
                    const rowIdx = state.dataTable.row($(this).closest('tr')).index();
                    const value = $(this).val();
                    debouncedNotesSave(rowIdx, value);
                });

                $('#myTable tbody').on('keydown', 'textarea.notes-textarea', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        $(this).blur();
                    }
                });

                clipboard.bindCopyEvents();
            },

            applyColumnClasses: () => {
                $('#myTable tbody tr').each(function() {
                    const $row = $(this);
                    const $cells = $row.find('td');
                    $cells.removeClass('text-column occurrences-column state-column notes-column');

                    config.headers.forEach((header, headerIndex) => {
                        const cellIndex = headerIndex + 1;
                        if (cellIndex < $cells.length) {
                            const $cell = $cells.eq(cellIndex);
                            
                            if (['CN', 'EN', 'CNTraditional'].includes(header) || 
                                (!['Occurrences', 'State', 'Notes'].includes(header) && cellIndex >= 2)) {
                                $cell.addClass('text-column');
                            } else if (header === 'Occurrences') {
                                $cell.addClass('occurrences-column');
                            } else if (header === 'State') {
                                $cell.addClass('state-column');
                            } else if (header === 'Notes') {
                                $cell.addClass('notes-column');
                            }
                        }
                    });
                });
            }
        };

        const progressTracker = {
            get: () => {
                const total = state.tableData.length;
                let reviewed = 0, passed = 0, failed = 0;
                
                for (let i = 0; i < total; i++) {
                    const stateValue = storage.getState(i);
                    if (stateValue) {
                        reviewed++;
                        if (stateValue === 'Pass') passed++;
                        if (stateValue === 'Fail') failed++;
                    }
                }
                
                return { total, reviewed, passed, failed };
            },

            update: () => {
                const progress = progressTracker.get();
                const percentage = Math.round((progress.reviewed / progress.total) * 100);
                const banner = document.querySelector('.info-banner p');
                
                if (banner) {
                    const originalParts = banner.textContent.split('•');
                    const baseText = originalParts.slice(0, 4).join('•') + '•';
                    banner.innerHTML = `${baseText} 📊 <strong>${progress.reviewed}/${progress.total}</strong> reviewed (<strong>${percentage}%</strong>) • ✅ <strong>${progress.passed}</strong> passed • ❌ <strong>${progress.failed}</strong> failed`;
                }
            }
        };

        const clipboard = {
            copy: (text, element) => {
                const rowIndex = state.dataTable.row(element).index();
                const cellIndex = $(element).index();
                let rawText = text;
                
                if (!state.showingRaw && config.rawData[rowIndex]) {
                    rawText = config.rawData[rowIndex][cellIndex - 1];
                }

                const decodedText = utils.decodeHtml(rawText);
                navigator.clipboard.writeText(decodedText).then(() => {
                    clipboard.showFeedback(element);
                });
            },

            showFeedback: (element) => {
                const feedback = document.createElement('div');
                feedback.className = 'copy-feedback show';
                feedback.textContent = 'Copied!';
                element.style.position = 'relative';
                element.appendChild(feedback);

                setTimeout(() => {
                    feedback.classList.remove('show');
                    setTimeout(() => {
                        if (feedback.parentNode && document.contains(feedback)) {
                            feedback.parentNode.removeChild(feedback);
                        }
                        $(element).removeClass('copyable-cell');
                    }, 300);
                }, 1000);
            },

            bindCopyEvents: () => {
                $('#myTable tbody').on('mouseenter', 'td:nth-child(2), td.text-column', function() {
                    $(this).addClass('copyable-cell');
                }).on('mouseleave', 'td:nth-child(2), td.text-column', function() {
                    if (!$(this).find('.copy-feedback').length) {
                        $(this).removeClass('copyable-cell');
                    }
                }).on('click', 'td:nth-child(2), td.text-column', function() {
                    const text = $(this).text().trim();
                    if (text) clipboard.copy(text, this);
                });
            }
        };

        const theme = {
            toggle: () => {
                const body = document.body;
                const btn = document.querySelector('.dark-mode-btn');
                const isDark = body.getAttribute('data-theme') === 'dark';
                
                if (isDark) {
                    body.removeAttribute('data-theme');
                    btn.textContent = '🌙 Dark';
                    localStorage.setItem('visualizer-theme', 'light');
                } else {
                    body.setAttribute('data-theme', 'dark');
                    btn.textContent = '☀️ Light';
                    localStorage.setItem('visualizer-theme', 'dark');
                }
            },

            initialize: () => {
                const savedTheme = localStorage.getItem('visualizer-theme');
                const btn = document.querySelector('.dark-mode-btn');
                
                if (savedTheme === 'dark') {
                    document.body.setAttribute('data-theme', 'dark');
                    btn.textContent = '☀️ Light';
                } else {
                    btn.textContent = '🌙 Dark';
                }
            }
        };

        const keyboard = {
            initialize: () => {
                $(document).keydown(keyboard.handleKeyDown);
                keyboard.showInitialHint();
            },

            handleKeyDown: (e) => {
                if (['SELECT', 'INPUT', 'TEXTAREA'].includes(e.target.tagName) && e.key !== 'Escape') {
                    return;
                }

                if (/^[0-9]$/.test(e.key) && (state.isKeyboardMode || state.zenMode)) {
                    e.preventDefault();
                    numberInput.add(e.key);
                    return;
                }

                if (e.key === 'g' && (state.isKeyboardMode || state.zenMode) && state.numberBuffer !== '') {
                    e.preventDefault();
                    numberInput.executeGoTo();
                    return;
                }

                if (e.key === 'Escape' && state.numberBuffer !== '') {
                    e.preventDefault();
                    numberInput.clear();
                    return;
                }

                if (e.ctrlKey || e.metaKey || e.altKey) {
                    keyboard.handleCtrlKeys(e);
                    return;
                }

                if (e.key.startsWith('F') && e.key.length > 1) return;

                keyboard.handleNormalKeys(e);
            },

            handleCtrlKeys: (e) => {
                if (state.zenMode) {
                    switch(e.key) {
                        case 'ArrowRight':
                        case 'l':
                            e.preventDefault();
                            zen.nextUnreviewed();
                            break;
                        case 'ArrowLeft':
                        case 'h':
                            e.preventDefault();
                            zen.previousUnreviewed();
                            break;
                    }
                } else {
                    switch(e.key) {
                        case 'ArrowRight':
                        case 'k':
                            e.preventDefault();
                            normal.nextUnreviewed();
                            break;
                        case 'ArrowLeft':
                        case 'j':
                            e.preventDefault();
                            normal.previousUnreviewed();
                            break;
                    }
                }
            },

            handleNormalKeys: (e) => {
                const keyActions = {
                    'p': () => state.zenMode ? zen.markPass() : normal.markCurrentRow('Pass'),
                    'f': () => state.zenMode ? zen.markFail() : normal.markCurrentRow('Fail'),
                    'c': () => state.zenMode ? zen.clear() : normal.clearCurrentRow(),
                    'P': () => !state.zenMode && normal.filter('pass'),
                    'F': () => !state.zenMode && normal.filter('fail'),
                    'A': () => !state.zenMode && normal.filter('all'),
                    'U': () => !state.zenMode && normal.filter('unreviewed'),
                    'ArrowDown': () => state.zenMode ? zen.next() : normal.navigateRow(1),
                    'j': () => state.zenMode ? zen.next() : normal.navigateRow(1),
                    'ArrowUp': () => state.zenMode ? zen.previous() : normal.navigateRow(-1),
                    'k': () => state.zenMode ? zen.previous() : normal.navigateRow(-1),
                    ' ': () => state.zenMode ? zen.next() : normal.enterKeyboardMode(),
                    'ArrowRight': () => state.zenMode && zen.next(),
                    'l': () => state.zenMode && zen.next(),
                    's': () => state.zenMode && zen.next(),
                    'ArrowLeft': () => state.zenMode && zen.previous(),
                    'h': () => state.zenMode && zen.previous(),
                    'Escape': () => keyboard.handleEscape(),
                    'Enter': () => state.zenMode ? document.getElementById('zenNotes').focus() : normal.focusNotes(),
                    'Z': () => !state.zenMode && zen.enter(),
                    '.': () => state.zenMode ? zen.toggleSpaces() : normal.toggleCurrentRowSpaces(),
                    'D': () => theme.toggle(),
                    'T': () => toggleData(),
                    'R': () => state.zenMode ? zen.toggleRaw() : toggleData(),
                    '?': () => keyboard.showHelp()
                };

                const action = keyActions[e.key];
                if (action) {
                    e.preventDefault();
                    action();
                }
            },

            handleEscape: () => {
                if (state.normalHelpOpen) {
                    normal.closeHelp();
                } else if (state.zenHelpOpen) {
                    zen.closeHelp();
                } else if (state.zenMode) {
                    zen.exit();
                } else {
                    normal.exitKeyboardMode();
                }
            },

            showHelp: () => {
                if (state.zenMode && !state.zenHelpOpen) {
                    zen.showHelp();
                } else if (!state.normalHelpOpen) {
                    state.normalHelpOpen = true;
                    normal.showHelp();
                }
            },

            showInitialHint: () => {
                $('.keyboard-hint').remove();
                $('body').append(`
                    <div class="keyboard-hint" style="
                        position: fixed; 
                        top: 15px; 
                        right: 10px; 
                        background: var(--bg-banner); 
                        color: var(--text-primary);
                        padding: 8px 12px; 
                        border-radius: 4px; 
                        font-size: 13px;
                        font-weight: 500;
                        z-index: 9999;
                        border: 1px solid var(--border-color);
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    ">
                        Press <kbd>Space</kbd> to start keyboard navigation, <kbd>Z</kbd> for Zen Mode, or <kbd>?</kbd> for help<br>
                        <small><kbd>p</kbd>/<kbd>f</kbd> mark • <kbd>P</kbd>/<kbd>F</kbd> filter</small>
                    </div>
                `);

                setTimeout(() => {
                    if (!state.isKeyboardMode && !state.zenMode) {
                        $('.keyboard-hint').fadeOut(1000, function() { $(this).remove(); });
                    }
                }, 4000);
            },

            showActiveHint: () => {
                $('.keyboard-hint').remove();
                const zIndexHint = state.zenMode ? 10003 : 9999;
                const zIndexSummary = state.zenMode ? 10004 : 9998;

                $('body').append(`
                    <div class="keyboard-hint" style="
                        position: fixed; 
                        top: 15px; 
                        right: 10px; 
                        background: var(--bg-banner); 
                        color: var(--text-primary);
                        padding: 8px 12px; 
                        border-radius: 4px; 
                        font-size: 13px;
                        font-weight: 500;
                        z-index: ${zIndexHint};
                        border: 1px solid var(--border-color);
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    ">
                        Press <kbd>Esc</kbd> to exit ${state.zenMode ? 'zen' : 'keyboard'} mode or <kbd>?</kbd> for help
                    </div>
                `);

                const shortcutText = state.zenMode ? 
                    `<strong>Zen Mode:</strong> <kbd>p</kbd>ass <kbd>f</kbd>ail <kbd>c</kbd>lear <kbd>s</kbd>kip<br>
                     <strong>Navigate:</strong> <kbd>↑↓</kbd> or <kbd>Space</kbd><br>` :
                    `<strong>Actions:</strong> <kbd>p</kbd>ass <kbd>f</kbd>ail <kbd>c</kbd>lear<br>
                     <strong>Filters:</strong> <kbd>P</kbd>ass <kbd>F</kbd>ail <kbd>A</kbd>ll <kbd>U</kbd>nreviewed<br>
                     <strong>Modes:</strong> <kbd>Z</kbd>en <kbd>D</kbd>ark <kbd>R</kbd>aw`;

                $('body').append(`
                    <div class="shortcut-summary" style="
                        position: fixed;
                        top: 60px;
                        right: 10px;
                        background: #007bff;
                        color: white;
                        padding: 10px 12px;
                        border-radius: 6px;
                        font-size: 11px;
                        z-index: ${zIndexSummary};
                        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        font-family: monospace;
                    ">
                        ${shortcutText}
                    </div>
                `);

                setTimeout(() => {
                    $('.shortcut-summary').fadeOut(800, function() { $(this).remove(); });
                }, 2000);
            },

            hideHint: () => {
                $('#keyboard-hint').remove();
                $('.shortcut-summary').remove();
                keyboard.showInitialHint();
            }
        };

        const numberInput = {
            add: (digit) => {
                state.numberBuffer += digit;
                numberInput.show();

                if (state.numberInputTimeout) {
                    clearTimeout(state.numberInputTimeout);
                }

                state.numberInputTimeout = setTimeout(() => {
                    numberInput.clear();
                }, config.numberInputTimeout);
            },

            show: () => {
                $('.number-buffer-display').remove();
                if (state.numberBuffer === '') return;

                const totalCount = state.zenMode ? state.tableData.length : state.dataTable.rows().count();
                const modeClass = state.zenMode ? 'zen' : 'normal';

                if (state.zenMode) {
                    $('#zenMode .zen-container').append(`
                        <div class="number-buffer-display zen show">
                            ${state.numberBuffer}
                        </div>
                    `);
                } else {
                    $('body').append(`
                        <div class="number-buffer-display normal show">
                            ${state.numberBuffer} / ${totalCount}
                        </div>
                    `);
                }
            },

            clear: () => {
                state.numberBuffer = '';
                $('.number-buffer-display').fadeOut(200, function() { $(this).remove(); });

                if (state.numberInputTimeout) {
                    clearTimeout(state.numberInputTimeout);
                    state.numberInputTimeout = null;
                }
            },

            executeGoTo: () => {
                if (state.numberBuffer === '') return;
                const targetNumber = parseInt(state.numberBuffer);

                if (state.zenMode) {
                    zen.goToString(targetNumber);
                } else {
                    normal.goToRow(targetNumber);
                }
                numberInput.clear();
            }
        };

        const normal = {
            enterKeyboardMode: () => {
                state.isKeyboardMode = true;
                normal.highlightCurrentRow();
                keyboard.showActiveHint();
            },

            exitKeyboardMode: () => {
                state.isKeyboardMode = false;
                state.currentRowSpacesMode = false;
                state.originalRowContent = {};
                $('#myTable tbody tr').removeClass('keyboard-focus');
                keyboard.hideHint();
            },

            getCurrentRow: () => $(state.dataTable.row(state.currentRowIndex).node()),

            highlightCurrentRow: () => {
                $('#myTable tbody tr').removeClass('keyboard-focus');
                normal.getCurrentRow().addClass('keyboard-focus');
            },

            scrollToCurrentRow: () => {
                const currentRow = normal.getCurrentRow();
                if (currentRow.length) {
                    currentRow[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            },

            navigateRow: (direction) => {
                if (!state.isKeyboardMode) return;

                if (state.currentRowSpacesMode) {
                    normal.toggleCurrentRowSpaces();
                }

                const totalRows = state.dataTable.rows().count();
                state.currentRowIndex += direction;
                state.currentRowIndex = Math.max(0, Math.min(state.currentRowIndex, totalRows - 1));

                normal.highlightCurrentRow();
                normal.scrollToCurrentRow();
            },

            markCurrentRow: (stateValue) => {
                if (!state.isKeyboardMode) return;
                const currentRow = normal.getCurrentRow();
                if (currentRow.length) {
                    const select = currentRow.find('.state-select');
                    select.val(stateValue).trigger('change');
                    normal.navigateRow(1);
                }
            },

            clearCurrentRow: () => {
                if (!state.isKeyboardMode) return;
                const currentRow = normal.getCurrentRow();
                if (currentRow.length) {
                    currentRow.find('.state-select').val('').trigger('change');
                }
            },

            focusNotes: () => {
                if (!state.isKeyboardMode) return;
                const currentRow = normal.getCurrentRow();
                const notesInput = currentRow.find('.notes-textarea');
                if (notesInput.length) notesInput.focus();
            },

            filter: (filterType) => {
                const messages = {
                    'all': 'Showing all entries',
                    'pass': 'Showing only passed entries',
                    'fail': 'Showing only failed entries',
                    'unreviewed': 'Showing only unreviewed entries'
                };

                if (filterType === 'all') {
                    $('#myTable tbody tr').show();
                } else {
                    $('#myTable tbody tr').hide();
                    $('#myTable tbody tr').each(function() {
                        const $row = $(this);
                        const $select = $row.find('.state-select');
                        const currentValue = $select.val();
                        let shouldShow = false;

                        if (filterType === 'pass' && currentValue === 'Pass') shouldShow = true;
                        else if (filterType === 'fail' && currentValue === 'Fail') shouldShow = true;
                        else if (filterType === 'unreviewed' && !currentValue) shouldShow = true;

                        if (shouldShow) $row.show();
                    });
                }

                utils.showFeedback(messages[filterType]);
            },

            nextUnreviewed: () => {
                if (!state.isKeyboardMode) return;
                const totalRows = state.dataTable.rows().count();

                for (let i = state.currentRowIndex + 1; i < totalRows; i++) {
                    if (!storage.getState(i)) {
                        state.currentRowIndex = i;
                        normal.highlightCurrentRow();
                        normal.scrollToCurrentRow();
                        utils.showFeedback('→ Next unreviewed', '#007bff');
                        return;
                    }
                }
                utils.showFeedback('No more unreviewed strings');
            },

            previousUnreviewed: () => {
                if (!state.isKeyboardMode) return;

                for (let i = state.currentRowIndex - 1; i >= 0; i--) {
                    if (!storage.getState(i)) {
                        state.currentRowIndex = i;
                        normal.highlightCurrentRow();
                        normal.scrollToCurrentRow();
                        utils.showFeedback('← Previous unreviewed', '#007bff');
                        return;
                    }
                }
                utils.showFeedback('No previous unreviewed strings');
            },

            goToRow: (rowNumber) => {
                if (!state.isKeyboardMode) return false;
                const totalRows = state.dataTable.rows().count();
                const targetIndex = Math.min(rowNumber - 1, totalRows - 1);

                if (targetIndex >= 0) {
                    state.currentRowIndex = Math.max(0, targetIndex);

                    const pageLength = state.dataTable.page.len();
                    const targetPage = Math.floor(targetIndex / pageLength);
                    state.dataTable.page(targetPage).draw('page');

                    normal.highlightCurrentRow();
                    normal.scrollToCurrentRow();
                    return true;
                }
                return false;
            },

            toggleCurrentRowSpaces: () => {
                if (!state.isKeyboardMode) return;
                
                state.currentRowSpacesMode = !state.currentRowSpacesMode;
                const currentRow = normal.getCurrentRow();
                
                if (state.currentRowSpacesMode) {
                    currentRow.find('td.text-column').each(function() {
                        const $cell = $(this);
                        const cellKey = 'current_row_' + $cell.index();
                        state.originalRowContent[cellKey] = $cell.html();
                        const originalText = $cell.text();
                        const spacedText = originalText.replace(/ /g, '•');
                        $cell.text(spacedText).addClass('spaces-active');
                    });
                    // utils.showFeedback('• Row spaces visible', '#ffc107');
                } else {
                    currentRow.find('td.text-column').each(function() {
                        const $cell = $(this);
                        const cellKey = 'current_row_' + $cell.index();
                        const originalContent = state.originalRowContent[cellKey];
                        if (originalContent) {
                            $cell.html(originalContent);
                            delete state.originalRowContent[cellKey];
                        }
                        $cell.removeClass('spaces-active');
                    });
                    // utils.showFeedback('Row spaces hidden', '#6c757d');
                }
            },

            showHelp: () => {
                const helpHTML = `
                    <div id="normalHelp" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                background: var(--bg-secondary); padding: 30px; border-radius: 12px; 
                                z-index: 10002; max-width: 600px; border: 1px solid var(--border-color);
                                box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <h3 style="margin-top: 0; color: var(--text-primary);">Keyboard Shortcuts</h3>
                        <div style="color: var(--text-primary); line-height: 1.8; font-size: 14px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <strong style="color: #007bff;">Navigation:</strong><br>
                                    <kbd>Space</kbd> Enter keyboard mode<br>
                                    <kbd>↑</kbd> / <kbd>k</kbd> Move up one row<br>
                                    <kbd>↓</kbd> / <kbd>j</kbd> Move down one row<br>
                                    <kbd>0-9</kbd> + <kbd>g</kbd> Go to row number<br>
                                    <kbd>Ctrl+→</kbd> Next unreviewed string<br>
                                    <kbd>Ctrl+←</kbd> Previous unreviewed string<br>
                                    <kbd>Enter</kbd> Focus notes field<br>
                                    <kbd>Esc</kbd> Exit keyboard mode<br><br>
                            
                                    <strong style="color: #28a745;">Review Actions:</strong><br>
                                    <kbd>p</kbd> Mark current row as Pass<br>
                                    <kbd>f</kbd> Mark current row as Fail<br>
                                    <kbd>c</kbd> Clear current row state<br>
                                    <kbd>.</kbd> Visualize spaces<br>
                                </div>
                                <div>
                                    <strong style="color: #dc3545;">Quick Filters:</strong><br>
                                    <kbd>P</kbd> Show only Passed entries<br>
                                    <kbd>F</kbd> Show only Failed entries<br>
                                    <kbd>U</kbd> Show only Unreviewed entries<br>
                                    <kbd>A</kbd> Show All entries<br><br>
                            
                                    <strong style="color: #6c757d;">Other Shortcuts:</strong><br>
                                    <kbd>Z</kbd> Enter Zen Mode<br>
                                    <kbd>T</kbd> / <kbd>R</kbd> Toggle Raw/Formatted view<br>
                                    <kbd>D</kbd> Toggle Dark/Light mode<br>
                                    <kbd>?</kbd> Show this help<br><br>
                            
                                    <strong style="color: #ffc107;">Copy Feature:</strong><br>
                                    <em>Click any text cell to copy content</em>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 25px; text-align: center;">
                            <button onclick="normal.closeHelp()" style="margin-right: 10px; padding: 8px 16px; 
                                    background: #007bff; color: white; text-align: center; border: none; border-radius: 4px; cursor: pointer;">
                                Got it!
                            </button>
                        </div>
                    </div>
                `;
                $('body').append(helpHTML);
            },

            closeHelp: () => {
                state.normalHelpOpen = false;
                $('#normalHelp').remove();
            }
        };

        const zen = {
            enter: () => {
                state.zenMode = true;
                keyboard.showActiveHint();
                state.zenCurrentIndex = state.currentRowIndex || 0;
                
                const zenHTML = `
                    <div class="zen-mode" id="zenMode">
                        <button class="zen-exit" onclick="zen.exit()">×</button>
                        <div class="zen-container">
                            <div class="zen-raw-indicator" id="zenRawIndicator">FORMATTED</div>
                            <div class="zen-state-indicator" id="zenStateIndicator">Unreviewed</div>
                            <div class="zen-feedback" id="zenFeedback">✓ Marked as Pass</div>
                            
                            <div class="zen-progress">String <span id="zenCurrent">1</span> of <span id="zenTotal">${state.tableData.length}</span></div>
                            <div class="zen-progress-bar">
                                <div class="zen-progress-fill" id="zenProgressFill"></div>
                            </div>

                            <div class="zen-string-id" id="zenStringId" onclick="zen.copyText(this, 'id')">STRING_ID</div>

                            <div class="zen-text-pair">
                                <div class="zen-source" id="zenSource" onclick="zen.copyText(this, 'source')">Source text here</div>
                                <div class="zen-target" id="zenTarget" onclick="zen.copyText(this, 'target')">Target text here</div>
                            </div>

                            <div class="zen-actions">
                                <button class="zen-btn zen-btn-nav" onclick="zen.previous()">← Previous</button>
                                <button class="zen-btn zen-btn-pass" onclick="zen.markPass()">✓ Pass</button>
                                <button class="zen-btn zen-btn-fail" onclick="zen.markFail()">✗ Fail</button>
                                <button class="zen-btn zen-btn-nav" onclick="zen.next()">Next →</button>
                            </div>

                            <div class="zen-occurrences" id="zenOccurrences" style="
                                position: absolute; 
                                bottom: 20px; 
                                left: 20px; 
                                background: var(--bg-banner); 
                                color: var(--text-secondary); 
                                padding: 6px 12px; 
                                border-radius: 4px; 
                                font-size: 12px; 
                                font-family: 'Courier New', monospace;
                                border: 1px solid var(--border-color);
                                display: none;">
                                Occurrences: <span id="zenOccurrencesCount">1</span>
                            </div>

                            <input type="text" class="zen-notes" id="zenNotes" placeholder="Add your notes here..." maxlength="200">
                        </div>
                    </div>
                `;

                $('body').append(zenHTML);
                zen.updateDisplay();
                $('#zenMode').focus();

                const debouncedNotesSave = utils.debounce((notes) => {
                    storage.setNotes(state.zenCurrentIndex, notes);
                    zen.updateMainTableNotes(state.zenCurrentIndex, notes);
                }, config.debounceDelay);

                $('#zenNotes').on('input', function() {
                    debouncedNotesSave($(this).val());
                }).on('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        $(this).blur();
                    }
                });
            },

            exit: () => {
                zen.clearSpaces();
                state.zenMode = false;
                $('#zenMode').fadeOut(200, function() { $(this).remove(); });
            },

            updateDisplay: () => {
                if (!state.zenMode) return;

                const currentData = state.tableData[state.zenCurrentIndex];
                const rawCurrentData = config.rawData[state.zenCurrentIndex];
                const progress = ((state.zenCurrentIndex + 1) / state.tableData.length) * 100;

                $('#zenCurrent').text(state.zenCurrentIndex + 1);
                $('#zenProgressFill').css('width', progress + '%');

                const dataToShow = state.zenShowingRaw ? rawCurrentData : currentData;
                const isChineseMode = utils.isChineseMode();

                $('#zenStringId').text(dataToShow[0]);

                if (isChineseMode) {
                    $('#zenSource').html(`<strong style="color: #007bff;">Source - ${config.headers[1]}</strong><br>${dataToShow[1]}`);
                    $('#zenTarget').html(`<strong style="color: #28a745;">Target - ${config.headers[3]}</strong><br>${dataToShow[3]}`);
                } else {
                    $('#zenSource').html(`<strong style="color: #007bff;">Source - ${config.headers[1]}</strong><br>${dataToShow[1]}`);
                    $('#zenTarget').html(`<strong style="color: #28a745;">Target - ${config.headers[2]}</strong><br>${dataToShow[2]}`);
                }

                const savedState = storage.getState(state.zenCurrentIndex);
                const stateIndicator = $('#zenStateIndicator');

                if (savedState === 'Pass') {
                    stateIndicator.text('✓ Pass').removeClass().addClass('zen-state-indicator zen-state-pass');
                } else if (savedState === 'Fail') {
                    stateIndicator.text('✗ Fail').removeClass().addClass('zen-state-indicator zen-state-fail');
                } else {
                    stateIndicator.text('Unreviewed').removeClass().addClass('zen-state-indicator zen-state-unreviewed');
                }

                const rawIndicator = $('#zenRawIndicator');
                rawIndicator.text(state.zenShowingRaw ? 'RAW' : 'FORMATTED');

                const savedNotes = storage.getNotes(state.zenCurrentIndex);
                $('#zenNotes').val(savedNotes);

                const occurrencesIndex = config.headers.indexOf('Occurrences');
                if (occurrencesIndex !== -1 && occurrencesIndex < dataToShow.length) {
                    $('#zenOccurrencesCount').text(dataToShow[occurrencesIndex]);
                    $('#zenOccurrences').show();
                } else {
                    $('#zenOccurrences').hide();
                }
            },

            next: () => {
                zen.clearSpaces();
                if (state.zenCurrentIndex < state.tableData.length - 1) {
                    state.zenCurrentIndex++;
                    zen.updateDisplay();
                }
            },

            previous: () => {
                zen.clearSpaces();
                if (state.zenCurrentIndex > 0) {
                    state.zenCurrentIndex--;
                    zen.updateDisplay();
                }
            },

            markPass: () => {
                storage.setState(state.zenCurrentIndex, 'Pass');
                zen.updateMainTableRow(state.zenCurrentIndex, 'Pass');
                zen.updateDisplay();
                setTimeout(() => zen.next(), 150);
            },

            markFail: () => {
                storage.setState(state.zenCurrentIndex, 'Fail');
                zen.updateMainTableRow(state.zenCurrentIndex, 'Fail');
                zen.updateDisplay();
                setTimeout(() => zen.next(), 150);
            },

            clear: () => {
                storage.clearState(state.zenCurrentIndex);
                zen.updateMainTableRow(state.zenCurrentIndex, '');
                zen.updateDisplay();
                zen.next();
            },

            nextUnreviewed: () => {
                for (let i = state.zenCurrentIndex + 1; i < state.tableData.length; i++) {
                    if (!storage.getState(i)) {
                        state.zenCurrentIndex = i;
                        zen.updateDisplay();
                        zen.showFeedback('→ Next unreviewed', '#007bff');
                        return;
                    }
                }
                zen.showFeedback('No more unreviewed');
            },

            previousUnreviewed: () => {
                for (let i = state.zenCurrentIndex - 1; i >= 0; i--) {
                    if (!storage.getState(i)) {
                        state.zenCurrentIndex = i;
                        zen.updateDisplay();
                        zen.showFeedback('← Prev unreviewed', '#007bff');
                        return;
                    }
                }
                zen.showFeedback('No prev unreviewed', '#6c757d');
            },

            goToString: (stringNumber) => {
                const targetIndex = Math.min(stringNumber - 1, state.tableData.length - 1);
                if (targetIndex >= 0) {
                    state.zenCurrentIndex = Math.max(0, targetIndex);
                    zen.updateDisplay();
                    return true;
                }
                return false;
            },

            toggleRaw: () => {
                state.zenShowingRaw = !state.zenShowingRaw;
                zen.updateDisplay();
            },

            toggleSpaces: () => {
                state.zenSpacesMode = !state.zenSpacesMode;
                
                if (state.zenSpacesMode) {
                    zen.showSpaces();
                } else {
                    zen.hideSpaces();
                }
            },

            showSpaces: () => {
                const sourceEl = document.getElementById('zenSource');
                const targetEl = document.getElementById('zenTarget');
                
                if (!sourceEl || !targetEl) return;

                state.originalZenContent.source = sourceEl.innerHTML;
                state.originalZenContent.target = targetEl.innerHTML;

                const sourceLines = sourceEl.innerHTML.split('<br>');
                const targetLines = targetEl.innerHTML.split('<br>');

                if (sourceLines.length >= 2) {
                    const sourceHeader = sourceLines[0];
                    const sourceText = sourceEl.textContent.replace(sourceEl.querySelector('strong').textContent, '').trim();
                    sourceEl.innerHTML = sourceHeader + '<br>' + sourceText.replace(/ /g, '•');
                }

                if (targetLines.length >= 2) {
                    const targetHeader = targetLines[0];
                    const targetText = targetEl.textContent.replace(targetEl.querySelector('strong').textContent, '').trim();
                    targetEl.innerHTML = targetHeader + '<br>' + targetText.replace(/ /g, '•');
                }

                sourceEl.classList.add('zen-spaces-active');
                targetEl.classList.add('zen-spaces-active');
                // utils.showFeedback('• Zen spaces visible', '#ffc107');
            },

            hideSpaces: () => {
                const sourceEl = document.getElementById('zenSource');
                const targetEl = document.getElementById('zenTarget');
                
                if (!sourceEl || !targetEl) return;

                if (state.originalZenContent.source) {
                    sourceEl.innerHTML = state.originalZenContent.source;
                    targetEl.innerHTML = state.originalZenContent.target;
                }

                sourceEl.classList.remove('zen-spaces-active');
                targetEl.classList.remove('zen-spaces-active');
                state.originalZenContent = {};
                // utils.showFeedback('Zen spaces hidden', '#6c757d');
            },

            clearSpaces: () => {
                if (state.zenSpacesMode) {
                    zen.hideSpaces();
                    state.zenSpacesMode = false;
                }
            },

            showFeedback: (message, color = 'rgba(0, 0, 0, 0.8)') => {
                const feedback = $('#zenFeedback');
                feedback.text(message).css('background', color).addClass('show');
                setTimeout(() => feedback.removeClass('show'), 800);
            },

            updateMainTableRow: (rowIndex, stateValue) => {
                if (state.dataTable && state.dataTable.row(rowIndex).node()) {
                    const row = $(state.dataTable.row(rowIndex).node());
                    const select = row.find('.state-select');
                    select.val(stateValue).trigger('change');
                }
            },

            updateMainTableNotes: (rowIndex, notes) => {
                if (state.dataTable && state.dataTable.row(rowIndex).node()) {
                    const row = $(state.dataTable.row(rowIndex).node());
                    const notesTextarea = row.find('.notes-textarea');
                    if (notesTextarea.length) notesTextarea.val(notes);
                }
            },

            copyText: (element, type) => {
                const currentData = state.tableData[state.zenCurrentIndex];
                const rawCurrentData = config.rawData[state.zenCurrentIndex];
                const isChineseMode = utils.isChineseMode();

                let textToCopy = '';
                switch(type) {
                    case 'id':
                        textToCopy = rawCurrentData[0];
                        break;
                    case 'source':
                        textToCopy = rawCurrentData[1];
                        break;
                    case 'target':
                        textToCopy = isChineseMode ? rawCurrentData[3] : rawCurrentData[2];
                        break;
                }

                const decodedText = utils.decodeHtml(textToCopy);
                navigator.clipboard.writeText(decodedText).then(() => {
                    clipboard.showFeedback(element);
                });
            },

            showHelp: () => {
                state.zenHelpOpen = true;
                const helpHTML = `
                    <div id="zenHelp" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                background: var(--bg-secondary); padding: 30px; border-radius: 12px; 
                                z-index: 10002; max-width: 500px; border: 1px solid var(--border-color);
                                box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <h3 style="margin-top: 0; color: var(--text-primary);">Zen Mode Shortcuts</h3>
                        <div style="color: var(--text-primary); line-height: 1.6;">
                            <strong>Review:</strong> <kbd>p</kbd> Pass, <kbd>f</kbd> Fail, <kbd>c</kbd> Clear<br>
                            <strong>Navigate:</strong> <kbd>↑↓</kbd> or <kbd>h</kbd> <kbd>j</kbd> <kbd>k</kbd> <kbd>l</kbd> or <kbd>Space</kbd><br>
                            <strong>Go To:</strong> <kbd>0-9</kbd> + <kbd>g</kbd> Jump to string number<br>
                            <strong>Smart Nav:</strong> <kbd>Ctrl+→</kbd> Next unreviewed, <kbd>Ctrl+←</kbd> Prev unreviewed<br>
                            <strong>Other:</strong> <kbd>Enter</kbd> Notes, <kbd>R</kbd> Raw toggle, <kbd>D</kbd> Dark mode, <kbd>.</kbd> Spaces visualization<br>
                            <strong>Exit:</strong> <kbd>Esc</kbd><br><br>
                            <strong>Copy:</strong> Click on any text to copy raw content
                        </div>
                        <button onclick="zen.closeHelp()" style="margin-top: 20px; padding: 8px 16px; 
                                background: #007bff; text-align: center; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Got it!
                        </button>
                    </div>
                `;
                $('body').append(helpHTML);
            },

            closeHelp: () => {
                state.zenHelpOpen = false;
                $('#zenHelp').remove();
            }
        };

        // Global functions for onclick handlers
        window.toggleData = () => {
            state.showingRaw = !state.showingRaw;
            dataRenderer.renderData(state.showingRaw ? config.rawData : config.formattedData);
            document.querySelector('.toggle-btn').textContent = state.showingRaw ? 'Show Formatted' : 'Show Raw';
        };

        window.toggleDarkMode = theme.toggle;
        window.normal = normal;
        window.zen = zen;

        window.clearAllStates = () => {
            const total = state.tableData.length;
            let clearedCount = 0;
            
            for (let i = 0; i < total; i++) {
                if (storage.getState(i)) {
                    storage.clearState(i);
                    clearedCount++;
                }
            }
            
            dataRenderer.renderData(state.tableData);
            
            if (clearedCount > 0) {
                alert(`✅ Cleared ${clearedCount} review states and all notes!`);
            } else {
                alert('ℹ️ No review states to clear.');
            }
        };

        // Initialize application
        $(document).ready(() => {
            theme.initialize();
            dataRenderer.renderData(config.formattedData);
            keyboard.initialize();
            progressTracker.update();
            
            $('#clearState').click(clearAllStates);
        });
    </script>
  </body>
</html>