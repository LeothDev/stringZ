<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>{{TITLE}}</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <style>
      :root {
        /* Light mode colors */
        --bg-primary: #f8f9fa;
        --bg-secondary: white;
        --bg-banner: #f8f9fa;
        --text-primary: #333;
        --text-secondary: #6c757d;
        --text-muted: #495057;
        --border-color: #dee2e6;
        --table-header-bg: #f8f9fa;
        --table-border: #dee2e6;
        --button-bg: #6c757d;
        --button-hover: #5a6268;
        --input-bg: white;
      }
      
      /* Dark mode colors */
      [data-theme="dark"] {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-banner: #343a40;
        --text-primary: #f8f9fa;
        --text-secondary: #adb5bd;
        --text-muted: #ced4da;
        --border-color: #495057;
        --table-header-bg: #343a40;
        --table-border: #495057;
        --button-bg: #495057;
        --button-hover: #5a6268;
        --input-bg: #343a40;
      }
      
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-primary);
        margin: 0;
        padding: 0;
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      
      .toggle-btn {
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 9999;
        padding: 8px 16px;
        background-color: var(--button-bg);
        color: white;
        border: 1px solid var(--button-bg);
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: background-color 0.2s ease;
      }
      
      .toggle-btn:hover {
        background-color: var(--button-hover);
        border-color: var(--button-hover);
      }
      
      .dark-mode-btn {
        position: fixed;
        top: 15px;
        left: 150px;
        z-index: 9999;
        padding: 8px 16px;
        background-color: var(--button-bg);
        color: white;
        border: 1px solid var(--button-bg);
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: background-color 0.2s ease;
      }
      
      .dark-mode-btn:hover {
        background-color: var(--button-hover);
        border-color: var(--button-hover);
      }
      
      #clearState {
        float: left;
        margin-right: 15px;
        margin-bottom: 15px;
        padding: 8px 16px;
        background-color: #dc3545;
        color: white;
        border: 1px solid #dc3545;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: background-color 0.2s ease;
      }
      
      #clearState:hover {
        background-color: #c82333;
        border-color: #bd2130;
      }
      
      .container {
        padding: 70px 30px 30px 30px;
        background: var(--bg-secondary);
        margin: 0;
        min-height: 100vh;
        transition: background-color 0.3s ease;
      }
      
      .info-banner {
        background-color: var(--bg-banner);
        border: 1px solid var(--border-color);
        color: var(--text-muted);
        padding: 20px;
        margin-bottom: 25px;
        border-radius: 4px;
        text-align: center;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      
      .info-banner h2 {
        margin: 0 0 10px 0;
        font-size: 24px;
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .info-banner p {
        margin: 0;
        font-size: 14px;
        color: var(--text-secondary);
      }
      
      #myTable {
        border: 1px solid var(--border-color);
        border-radius: 4px;
        overflow: hidden;
        transition: border-color 0.3s ease;
      }
      
      #myTable td {
        user-select: text !important;
        padding: 12px 8px;
        vertical-align: top;
        border-bottom: 1px solid var(--table-border);
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      
      #myTable th {
        background-color: var(--table-header-bg);
        border-bottom: 2px solid var(--border-color);
        color: var(--text-muted);
        font-weight: 600;
        padding: 15px 8px;
        text-align: center;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      
      /* Enhanced styling for different columns */
      #myTable td:first-child {
        text-align: center;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        color: var(--text-secondary);
        width: 50px;
      }
      
      #myTable td:nth-child(2) {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        color: var(--text-secondary);
        text-align: left;
        max-width: 80px;
        min-width: 60px;
        width: 80px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      #myTable td.text-column {
        line-height: 1.4;
        max-width: 200px;
        word-wrap: break-word;
        text-align: left;
        font-weight: normal;
      }

      /* Occurrences Column */
      #myTable td.occurrences-column {
        font-weight: 600;
        font-size: 14px;
        width: 80px;
        text-align: center;
        color: var(--text-muted);
      }

      /* State Column */
      #myTable td.state-column {
        min-width: 120px;
        max-width: 150px;
        text-align: center;
      }

      /* Notes Column */
      #myTable td.notes-column {
        min-width: 150px;
        max-width: 200px;
      }
      
      select.state-select {
        width: 100%;
        font-weight: 500;
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        background-color: var(--input-bg);
        color: var(--text-primary);
        transition: all 0.3s ease;
      }
      
      input.notes-input {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 12px;
        background-color: var(--input-bg);
        color: var(--text-primary);
        transition: all 0.3s ease;
      }
      
      input.notes-input:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
      }
      
      input.notes-input::placeholder {
        color: var(--text-secondary);
        font-style: italic;
      }
      
      select.state-select:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
      }
      
      select.state-select.pass {
        color: #28a745;
        border-color: #28a745;
      }
      
      select.state-select.fail {
        color: #dc3545;
        border-color: #dc3545;
      }
      
      /* DataTables styling */
      .dataTables_wrapper {
        color: var(--text-primary);
      }
      
      .dataTables_wrapper .dataTables_length,
      .dataTables_wrapper .dataTables_filter,
      .dataTables_wrapper .dataTables_info,
      .dataTables_wrapper .dataTables_paginate {
        margin: 15px 0;
      }
      
      .dataTables_wrapper .dataTables_filter input {
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 6px 12px;
        margin-left: 8px;
        background-color: var(--input-bg);
        color: var(--text-primary);
        transition: all 0.3s ease;
      }
      
      .dataTables_wrapper .dataTables_length select {
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 4px 8px;
        margin: 0 8px;
        background-color: var(--input-bg);
        color: var(--text-primary);
        transition: all 0.3s ease;
      }
      
      .dataTables_wrapper .dataTables_paginate .paginate_button {
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 6px 12px;
        margin: 0 2px;
        background-color: var(--input-bg);
        color: var(--text-primary) !important;
        transition: all 0.3s ease;
      }
      
      .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background-color: var(--bg-banner);
        border-color: var(--text-secondary);
      }
      
      .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background-color: #007bff;
        border-color: #007bff;
        color: white !important;
      }

      /* Copy feature styling */
    .copyable-cell {
        cursor: pointer;
        position: relative;
        transition: background-color 0.2s ease;
    }

    .copyable-cell:hover {
        background-color: rgba(0, 123, 255, 0.1) !important;
    }

    .copy-feedback {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .copy-feedback.show {
        opacity: 1;
    }

    .keyboard-focus {
      background-color: rgba(0, 123, 255, 0.08) !important;
      border: 2px solid #007bff !important;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2) !important;
    }

    .keyboard-focus td {
      background-color: rgba(0, 123, 255, 0.05) !important;
    }

    kbd {
      background-color: var(--button-bg);
      color: white;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 11px;
      font-family: monospace;
    }

    /* Zen Mode */
    .zen-mode {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--bg-primary);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .zen-container {
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      text-align: center;
      position: relative;
    }

    .zen-progress {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .zen-progress-bar {
      width: 200px;
      height: 6px;
      background: var(--border-color);
      border-radius: 3px;
      margin: 10px auto 40px;
      overflow: hidden;
    }

    .zen-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #28a745);
      transition: width 0.3s ease;
    }

    .zen-string-id {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: var(--text-secondary);
      background: var(--bg-banner);
      padding: 8px 16px;
      border-radius: 6px;
      margin-bottom: 30px;
      display: inline-block;
      cursor: pointer;
    }

    .zen-source, .zen-target, .zen-string-id {
      cursor: pointer;
      position: relative;
      transition: background-color 0.2s ease;
    }

    .zen-source:hover, .zen-target:hover, .zen-string-id:hover {
      background-color: rgba(0, 123, 255, 0.1);
    }

    .zen-text-pair {
      margin: 30px 0;
    }

    .zen-source, .zen-target {
      font-size: 18px;
      text-align: left;
      line-height: 1.6;
      margin: 20px 0;
      padding: 20px;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .zen-source {
      background: var(--bg-banner);
      border-left: 4px solid #007bff;
      color: var(--text-primary);
    }

    .zen-target {
      background: var(--bg-banner);
      border-left: 4px solid #28a745;
      color: var(--text-primary);
    }

    .zen-actions {
      margin: 30px 0;
    }

    .zen-btn {
      padding: 12px 24px;
      margin: 0 8px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .zen-btn-pass {
      background: #28a745;
      color: white;
    }

    .zen-btn-fail {
      background: #dc3545;
      color: white;
    }

    .zen-btn-nav {
      background: var(--button-bg);
      color: white;
    }

    .zen-notes {
      width: 100%;
      max-width: 500px;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      margin-top: 20px;
    }

    .zen-exit {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .zen-state-indicator {
      position: absolute;
      top: 30px;
      right: 20px;
      transform: translateY(-50%);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      z-index: 10001;
    }

    .zen-state-unreviewed {
      background: var(--border-color);
      color: var(--text-secondary);
    }

    .zen-state-pass {
      background: #28a745;
      color: white;
    }

    .zen-state-fail {
      background: #dc3545;
      color: white;
    }

    .zen-feedback {
      position: absolute;
      top: 50px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 18px;
      z-index: 10001;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .zen-feedback.show {
      opacity: 1;
    }

    .zen-raw-indicator {
      position: absolute;
      top: 20px;
      left: 20px;
      background: #6c757d;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    /* Number input display */
    .number-buffer-display {
      position: fixed;
      background: #007bff;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 10005;
    }

    /* Normal mode: top-right */
    .number-buffer-display.normal {
      top: 60px;
      right: 10px;
      z-index: 9999;
    }

    /* Zen mode: bottom-right */
    .number-buffer-display.zen {
      position: absolute;
      bottom: 15px;
      right: 15px;
      z-index: 10005;
    }

    .number-buffer-display.show {
      opacity: 1;
    }
    </style>
  </head>
  <body>
    <button class="toggle-btn" onclick="toggleData()">Show Raw</button>
    <button class="dark-mode-btn" onclick="toggleDarkMode()">🌙 Dark</button>
    <div class="container">
      <div class="info-banner">
        <h2>{{TITLE}}</h2>
        <p>📊
          <strong>{{ENTRY_COUNT}}</strong>
          strings • 🌍
          <strong>{{SOURCE_LANG}}</strong>
          →
          <strong>{{TARGET_LANG}}</strong>
          • 📝
          <strong>{{WORD_COUNT}}</strong>
          words • 🛠️ Generated by StringZ</p>
      </div>
      <button id="clearState">Clear All States</button>
      <table id="myTable" class="display" style="width:100%"></table>
    </div>
    <script>
      const headers = {{HEADERS_JS}};
      const rawData = {{RAW_DATA_JS}};
      const formattedData = {{FORMATTED_DATA_JS}};
      let showingRaw = false;
      let tableData = formattedData;
      let dataTable;
  
      function getStateKey(index) {
          return "state_{{TITLE}}_row_" + index; 
      }
      
      function getNotesKey(index) {
          return "notes_{{TITLE}}_row_" + index;
      }
  
      function generateRowWithState(row, idx) {
          const savedState = localStorage.getItem(getStateKey(idx)) || "";
          const savedNotes = localStorage.getItem(getNotesKey(idx)) || "";

          let stateClass = '';
          if (savedState) {
            stateClass = savedState.toLowerCase();
          }
          
          const selectHTML = '<select class="state-select ' + stateClass + '">' +
              '<option value="" ' + (savedState === "" ? "selected" : "") + '></option>' +
              '<option value="Pass" ' + (savedState === "Pass" ? "selected" : "") + '>Pass</option>' +
              '<option value="Fail" ' + (savedState === "Fail" ? "selected" : "") + '>Fail</option>' +
              '</select>';
          
          const notesHTML = '<input type="text" class="notes-input" value="' + 
              savedNotes.replace(/"/g, '&quot;') + 
              '" placeholder="Personal notes..." maxlength="200">';
          
          const newRow = row.slice();
          const stateIndex = headers.indexOf("State") + 1;
          const notesIndex = headers.indexOf("Notes") + 1;
          newRow[stateIndex] = selectHTML;
          newRow[notesIndex] = notesHTML;
          return newRow;
      }
  
      function renderData(data) {
          tableData = data;
          const transformed = data.map((row, idx) => {
            const rowWithNumber = [idx + 1, ...row];
            return generateRowWithState(rowWithNumber, idx);
          });

          if (!dataTable) {
              const columnsWithNumber = [{ title: '#' }, ...headers.map(h => ({ title: h }))];
              dataTable = $('#myTable').DataTable({
                  data: transformed,
                  columns: columnsWithNumber,
                  scrollX: true,
                  paging: true,
                  searching: true,
                  ordering: true,
                  deferRender: true,
                  lengthMenu: [[-1, 10, 25, 50], ["All", 10, 25, 50]],
                  order: [],
                  columnDefs: [
                      {
                          targets: headers.indexOf("State"),
                          orderable: true
                      }
                  ]
              });

              console.log('DataTable columns:', dataTable.settings()[0].aoColumns.map((col, idx) => `${idx}: ${col.sTitle}`));
              console.log('Headers array:', headers);
              console.log('State column should be at index:', headers.indexOf("State") + 1);        
              $('#myTable tbody').on('change', 'select.state-select', function () {
                  const rowIdx = dataTable.row($(this).closest('tr')).index();
                  const value = $(this).val();
                  localStorage.setItem(getStateKey(rowIdx), value);
                  $(this).removeClass('pass fail');
                  if (value) {
                    $(this).addClass(value.toLowerCase());
                  }
              });

              
              // Little debounce feature to avoid storing every letter one by one
              let notesTimeout;
              $('#myTable tbody').on('input', 'input.notes-input', function () {
                  const rowIdx = dataTable.row($(this).closest('tr')).index();
                  const value = $(this).val();

                  clearTimeout(notesTimeout);

                  notesTimeout = setTimeout(() => {
                    localStorage.setItem(getNotesKey(rowIdx), value);
                  }, 300);
              });

              $('#myTable tbody').on('keydown', 'input.notes-input', function(e) {
                if (e.key === 'Enter') {
                  e.preventDefault();
                  $(this).blur(); // Remove focus from notes
                }
              });
          } else {
              const currentPage = dataTable.page();
              const currentLength = dataTable.page.len();
              dataTable.clear().rows.add(transformed).draw(false);
              dataTable.page.len(currentLength).draw();
              dataTable.page(currentPage).draw(false);
          }

          setTimeout(() => {
            applyColumnClasses();
          }, 100);
      }
  
      function toggleData() {
          showingRaw = !showingRaw;
          renderData(showingRaw ? rawData : formattedData);
          
          // Update button text
          const btn = document.querySelector('.toggle-btn');
          btn.textContent = showingRaw ? 'Show Formatted' : 'Show Raw';
      }
  
      function clearAllStates() {
          const total = tableData.length;
          let clearedCount = 0;
          
          for (let i = 0; i < total; i++) {
              const stateKey = getStateKey(i);
              const notesKey = getNotesKey(i);
              
              if (localStorage.getItem(stateKey)) {
                  localStorage.removeItem(stateKey);
                  clearedCount++;
              }
              if (localStorage.getItem(notesKey)) {
                  localStorage.removeItem(notesKey);
              }
          }
          
          renderData(tableData);
          
          // Better user feedback
          if (clearedCount > 0) {
              alert(`✅ Cleared ${clearedCount} review states and all notes!`);
          } else {
              alert('ℹ️ No review states to clear.');
          }
      }
  
      function getProgress() {
          const total = tableData.length;
          let reviewed = 0;
          let passed = 0;
          let failed = 0;
          
          for (let i = 0; i < total; i++) {
              const state = localStorage.getItem(getStateKey(i));
              if (state) {
                  reviewed++;
                  if (state === 'Pass') passed++;
                  if (state === 'Fail') failed++;
              }
          }
          
          return { total, reviewed, passed, failed };
      }
      
      function updateProgressDisplay() {
          const progress = getProgress();
          const percentage = Math.round((progress.reviewed / progress.total) * 100);
          
          // Update the info banner with progress
          const banner = document.querySelector('.info-banner p');
          if (banner) {
              const originalText = banner.textContent.split('•')[0] + '•';
              banner.innerHTML = `${originalText} 📊 <strong>${progress.reviewed}/${progress.total}</strong> reviewed (<strong>${percentage}%</strong>) • ✅ <strong>${progress.passed}</strong> passed • ❌ <strong>${progress.failed}</strong> failed`;
          }
      }
  
      function toggleDarkMode() {
          const body = document.body;
          const btn = document.querySelector('.dark-mode-btn');
          const isDark = body.getAttribute('data-theme') === 'dark';
          
          if (isDark) {
              body.removeAttribute('data-theme');
              btn.textContent = '🌙 Dark';
              localStorage.setItem('visualizer-theme', 'light');
          } else {
              body.setAttribute('data-theme', 'dark');
              btn.textContent = '☀️ Light'; 
              localStorage.setItem('visualizer-theme', 'dark');
          }
      }
      
      function initializeTheme() {
          const savedTheme = localStorage.getItem('visualizer-theme');
          const btn = document.querySelector('.dark-mode-btn');
          
          if (savedTheme === 'dark') {
              document.body.setAttribute('data-theme', 'dark');
              btn.textContent = '☀️ Light';
          } else {
              btn.textContent = '🌙 Dark';
          }
      }

      // New copyToClipboard function to copy ONLY the rawText
      // Can be updated to copy depending on the Formatting/Raw toggle
      function copyToClipboard(text, element) {
          const rowIndex = dataTable.row(element).index();
          const cellIndex = $(element).index();

          let rawText = text;
          if (!showingRaw && rawData[rowIndex]) {
              rawText = rawData[rowIndex][cellIndex - 1];
          }

          // Decode HTML entities to get original text
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = rawText;
          const decodedText = tempDiv.textContent || tempDiv.innerText || rawText;

          navigator.clipboard.writeText(decodedText).then(() => {
              // Show feedback
              const feedback = document.createElement('div');
              feedback.className = 'copy-feedback show';
              feedback.textContent = 'Copied!';
              element.style.position = 'relative';
              element.appendChild(feedback);

              setTimeout(() => {
                  feedback.classList.remove('show');
                  setTimeout(() => {
                      if (feedback.parentNode && document.contains(feedback)) {
                          feedback.parentNode.removeChild(feedback);
                      }
                      $(element).removeClass('copyable-cell');
                  }, 300);
              }, 1000);
          });
      }        

      $(document).ready(function () {
        initializeTheme();
        renderData(formattedData);
        $('#clearState').click(clearAllStates);

        // Update progress on page load
        updateProgressDisplay();

        // Update progress when states change
        $('#myTable tbody').on('change', 'select.state-select', function () {
            setTimeout(updateProgressDisplay, 100);
        });

        $('#myTable tbody').on('mouseenter', 'td.text-column', function() {
          $(this).addClass('copyable-cell');
        }).on('mouseleave', 'td.text-column', function() {
          if (!$(this).find('.copy-feedback').length) {
            $(this).removeClass('copyable-cell');
          }
        }).on('click', 'td.text-column', function() {
          const text = $(this).text().trim();
          if (text) {
            copyToClipboard(text, this);
          }
        });

        // Initialize keyboard navigation and show initial hint
        initKeyboardNavigation();
        showInitialHint();
      });

      // Keyboard shortcuts
      let currentRowIndex = 0;
      let isKeyboardMode = false;
      let normalHelpOpen = false;
      // Number input display for fast jumps
      let numberBuffer = '';
      let numberInputTimeout = null;

      function initKeyboardNavigation() {
        $(document).keydown(function(e) {
          // Important, don't interfere when typing in inputs
          if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') {
            if (e.key != 'Escape') return;
          }

          if (/^[0-9]$/.test(e.key)) {
            if (isKeyboardMode || zenMode) {
              e.preventDefault();
              console.log('Number detected:', e.key, 'Keyboard mode:', isKeyboardMode, 'Zen mode:', zenMode);
              addToNumberBuffer(e.key);
              return;
            } else {
              console.log('Number ignored - not in keyboard or zen mode');
            }
          }

          // go-to
          if (e.key === 'g') {
            if ((isKeyboardMode || zenMode) && numberBuffer !== '') {
              e.preventDefault();
              executeGoTo();
              return;
            }
          }

          // Deal with Ctrl keys FIRST
          if (e.ctrlKey) {
            if (zenMode) {
              switch(e.key) {
                case 'ArrowRight':
                case 'l':
                  e.preventDefault();
                  zenNextUnreviewed();
                  return;
                case 'ArrowLeft':
                case 'h':
                  e.preventDefault();
                  zenPreviousUnreviewed();
                  return;
              }
            } else {
              switch(e.key) {
                case 'ArrowRight':
                case 'k':
                  e.preventDefault();
                  normalNextUnreviewed();
                  return;
                case 'ArrowLeft':
                case 'j':
                  e.preventDefault();
                  normalPreviousUnreviewed();
                  return;
              }
            }
          }

          // Clear the buffer!
          if (e.key === 'Escape') {
            if (numberBuffer !== '') {
              e.preventDefault();
              clearNumberBuffer();
              return;
            }
          }

          // Even more important! DO NOT INTERFERE WITH BROWSER SHORTCUTS
          if (e.ctrlKey || e.metaKey || e.altKey) return;

          // Don't interfere with Fn keys either
          if (e.key.startsWith('F') && e.key.length > 1) return;

          const table = $('#myTable').DataTable();
          const totalRows = table.rows().count();

          switch(e.key) {             
            // Actions (lowercase)
            case 'p':
              e.preventDefault();
              if (zenMode) {
                zenMarkPass();
              } else {
                markCurrentRow('Pass');
              }
              break;
            case 'f':
              e.preventDefault();
              if (zenMode) {
                zenMarkFail();
              } else {
                markCurrentRow('Fail');
              }
              break;
            case 'c':
              e.preventDefault();
              if (zenMode) {
                localStorage.removeItem(getStateKey(zenCurrentIndex));
                localStorage.removeItem(getNotesKey(zenCurrentIndex));
                zenNext();
              } else {
                clearCurrentRow();
              }
              break;

            // Filters (UPPERCASE) - Only working in normal mode
            case 'P':
              e.preventDefault();
              filterByState('pass');
              break;
            case 'F':
              e.preventDefault();
              filterByState('fail');
              break;
            case 'A':
              e.preventDefault();
              filterByState('all');
              break;
            case 'U':
              e.preventDefault();
              filterByState('unreviewed');
              break;

            // Navigation
            case 'ArrowDown':
            case 'j':
              e.preventDefault();
              if (zenMode) {
                zenNext();
              } else {
                navigateRow(1);
              }
              break;
            case 'ArrowUp':
            case 'k':
              e.preventDefault();
              if (zenMode) {
                zenPrevious();
              } else {
                navigateRow(-1);
              }
              break;

            // Zen Mode Navigation
            case ' ':
              e.preventDefault();
              if (zenMode) {
                zenNext();
              } else {
                enterKeyboardMode();
              }
            case 'ArrowRight':
            case 'l':
            case 's':
              e.preventDefault();
              if (zenMode) {
                zenNext();
              }
              break;
            case 'ArrowLeft':
            case 'h':
              e.preventDefault();
              if (zenMode) {
                zenPrevious();
              }
              break;

            // Modes
            case 'Escape':
              e.preventDefault();
              if (normalHelpOpen) {
                closeNormalHelp();
                normalHelpOpen = false;
              } else if (zenHelpOpen) {
                closeZenHelp();
              } else if (zenMode) {
                exitZenMode();
              } else {
                exitKeyboardMode();
              }
              break;
            case 'Enter':
              e.preventDefault();
              if (zenMode) {
                document.getElementById('zenNotes').focus();
              } else {
                focusNotes();
              }
              break;
            case 'Z':
              e.preventDefault();
              if (!zenMode) {
                enterZenMode();
              }
              break;


            // Other shortcuts
            case 'D':
              e.preventDefault();
              toggleDarkMode();
              break;
            case 'T':
            case 'R':
              e.preventDefault();
              if (zenMode) {
                zenToggleRaw();
              } else {
              toggleData();
              }
              break;

            // Extras
            case '?':
              e.preventDefault();
              if (zenMode) {
                if (!zenHelpOpen) {
                  showZenHelp();
                }
              } else {
                if (!normalHelpOpen) {
                  normalHelpOpen = true;
                  showNormalHelp();
                }
              }
              break;
            }
        });
      }

      function markCurrentRow(state) {
        if (!isKeyboardMode) return;

        const currentRow = getCurrentRow();
        if (currentRow.length) {
          const select = currentRow.find('.state-select');
          select.val(state).trigger('change');
          navigateRow(1);
        }
      }

      function clearCurrentRow() {
        if (!isKeyboardMode) return;

        const currentRow = getCurrentRow();
        if (currentRow.length) {
          currentRow.find('.state-select').val('').trigger('change');
          // currentRow.find('.notes-input').val('').trigger('input');
        }
      }

      function navigateRow(direction) {
        if (!isKeyboardMode) return;

        const table = $('#myTable').DataTable();
        const totalRows = table.rows().count();

        currentRowIndex += direction;
        if (currentRowIndex < 0) currentRowIndex = 0;
        if (currentRowIndex >= totalRows) currentRowIndex = totalRows - 1;

        highlightCurrentRow();
        scrollToCurrentRow();
      }

      function getCurrentRow() {
        const table = $('#myTable').DataTable();
        return $(table.row(currentRowIndex).node());
      }

      function highlightCurrentRow() {
        $('#myTable tbody tr').removeClass('keyboard-focus');

        const currentRow = getCurrentRow();
        currentRow.addClass('keyboard-focus');
      }

      function scrollToCurrentRow() {
        const currentRow = getCurrentRow();
        if (currentRow.length) {
          currentRow[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }

      function focusNotes() {
        if (!isKeyboardMode) return;

        const currentRow = getCurrentRow();
        const notesInput = currentRow.find('.notes-input');
        if (notesInput.length) {
          notesInput.focus();
        }
      }

      function enterKeyboardMode() {
        isKeyboardMode = true;
        highlightCurrentRow();
        showKeyboardHint();
      }

      function exitKeyboardMode() {
        isKeyboardMode = false;
        $('#myTable tbody tr').removeClass('keyboard-focus')
        hideKeyboardHint();
      }

      function showInitialHint() {
          $('.keyboard-hint').remove();

          $('body').append(`
              <div class="keyboard-hint" style="
                  position: flex; 
                  top: 15px; 
                  right: 10px; 
                  background: var(--bg-banner); 
                  color: var(--text-primary);
                  padding: 8px 12px; 
                  border-radius: 4px; 
                  font-size: 13px;
                  font-weight: 500;
                  z-index: 9999;
                  border: 1px solid var(--border-color);
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              ">
                  Press <kbd>Space</kbd> to start keyboard navigation, <kbd>Z</kbd> for Zen Mode, or <kbd>?</kbd> for help<br>
                  <small><kbd>p</kbd>/<kbd>f</kbd> mark • <kbd>P</kbd>/<kbd>F</kbd> filter</small>
              </div>
          `);

          // Auto-hide after delay. If in keyboardMode never succeeds
          setTimeout(() => {
            if (!isKeyboardMode && !zenMode) {
              $('.keyboard-hint').fadeOut(1000, function() {
                $(this).remove();
              });
            }
          }, 4000);
      }

      function showKeyboardHint() {
        $('.keyboard-hint').remove();

        const zIndexHint = zenMode ? 10003 : 9999;
        const zIndexSummary = zenMode ? 10004 : 9998;

        $('body').append(`
            <div class="keyboard-hint" style="
                position: fixed; 
                top: 15px; 
                right: 10px; 
                background: var(--bg-banner); 
                color: var(--text-primary);
                padding: 8px 12px; 
                border-radius: 4px; 
                font-size: 13px;
                font-weight: 500;
                z-index: ${zIndexHint};
                border: 1px solid var(--border-color);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            ">
                Press <kbd>Esc</kbd> to exit ${zenMode ? 'zen' : 'keyboard'} mode or <kbd>?</kbd> for help
            </div>
        `);

        const shortcutText = zenMode ? 
          `<strong>Zen Mode:</strong> <kbd>p</kbd>ass <kbd>f</kbd>ail <kbd>c</kbd>lear <kbd>s</kbd>kip<br>
           <strong>Navigate:</strong> <kbd>→←</kbd> or <kbd>Space</kbd><br>` :
          `<strong>Actions:</strong> <kbd>p</kbd>ass <kbd>f</kbd>ail <kbd>c</kbd>lear<br>
           <strong>Filters:</strong> <kbd>P</kbd>ass <kbd>F</kbd>ail <kbd>A</kbd>ll <kbd>U</kbd>nreviewed<br>
           <strong>Modes:</strong> <kbd>Z</kbd>en <kbd>D</kbd>ark <kbd>R</kbd>aw`;

        $('body').append(`
        <div class="shortcut-summary" style="
            position: fixed;
            top: 60px;
            right: 10px;
            background: #007bff;
            color: white;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 11px;
            z-index: ${zIndexSummary};
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-family: monospace;
        ">
          ${shortcutText}
        </div>
      `);

        setTimeout(() => {
          $('.shortcut-summary').fadeOut(800, function() {
            $(this).remove();
          });
        }, 2000);
      }            

      function hideKeyboardHint() {
        $('#keyboard-hint').remove();
        $('.shortcut-summary').remove();
        showInitialHint();
      }

      function filterByState(filterType) {
        console.log(`Filtering by: ${filterType}`);

        if (filterType === 'all') {
          // Show all rows
          $('#myTable tbody tr').show();
        } else {
          // Hide all rows first
          $('#myTable tbody tr').hide();

          // Show only matching rows
          $('#myTable tbody tr').each(function() {
            const $row = $(this);
            const $select = $row.find('.state-select');
            const currentValue = $select.val();

            let shouldShow = false;

            if (filterType === 'pass' && currentValue === 'Pass') {
              shouldShow = true;
            } else if (filterType === 'fail' && currentValue === 'Fail') {
              shouldShow = true;
            } else if (filterType === 'unreviewed' && (!currentValue || currentValue === '')) {
              shouldShow = true;
            }

            if (shouldShow) {
              $row.show();
            }
          });
        }

        showFilterFeedback(filterType);
      }            
      
      function showFilterFeedback(filterType) {
        const messages = {
          'all': 'Showing all entries',
          'pass': 'Showing only passed entries',
          'fail': 'Showing only failed entries',
          'unreviewed': 'Showing only unreviewed entries',
          'nextunreviewed': '→ Next unreviewed',
          'prevunreviewed': '← Previous unreviewed',
          'noprevunreviewed': 'No previous unreviewed strings',
          'goto': `→ Row ${Math.min(parseInt(numberBuffer || '0'), $('#myTable').DataTable().rows().count())}`
        };

        const feedbackColor = (() => {
          if (filterType.includes('unreviewed') && !filterType.includes('no')) return '#007bff';
          if (filterType === 'goto') return '#28a745';
          return '#6c757d';
        })();

        const feedback = $(`<div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: ${feedbackColor}; color: white; padding: 8px 16px; border-radius: 4px; z-index: 10000;">${messages[filterType]}</div>`);
        $('body').append(feedback);

        setTimeout(() => {
          feedback.fadeOut(300, function() { $(this).remove(); });
        }, 1500);
      }

      //  Next unreviewed - Normal mode
      function normalNextUnreviewed() {
        if (!isKeyboardMode) return;

        const table = $('#myTable').DataTable();
        const totalRows = table.rows().count()

        for (let i = currentRowIndex + 1; i < totalRows; i++) {
          const state = localStorage.getItem(getStateKey(i));
          if (!state || state === '') {
            currentRowIndex = i;
            highlightCurrentRow();
            scrollToCurrentRow();
            showFilterFeedback('nextunreviewed');
            return;
          }
        }

        showFilterFeedback('nonextunreviewed');
      }

      function normalPreviousUnreviewed() {
        if (!isKeyboardMode) return;

        const table = $('#myTable').DataTable();

        for (let i = currentRowIndex - 1; i >= 0; i--) {
          const state = localStorage.getItem(getStateKey(i));
          if (!state || state === '') {
            currentRowIndex = i;
            highlightCurrentRow();
            scrollToCurrentRow();
            showFilterFeedback('prevunreviewed');
            return;
          }
        }      

        showFilterFeedback('noprevunreviewed');
      }

      // Normal Mode Help Window
      function showNormalHelp() {
        normalHelpOpen = true;
      
        const helpHTML = `
          <div id="normalHelp" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                      background: var(--bg-secondary); padding: 30px; border-radius: 12px; 
                      z-index: 10002; max-width: 600px; border: 1px solid var(--border-color);
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="margin-top: 0; color: var(--text-primary);">Keyboard Shortcuts</h3>
            <div style="color: var(--text-primary); line-height: 1.8; font-size: 14px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                  <strong style="color: #007bff;">Navigation:</strong><br>
                  <kbd>Space</kbd> Enter keyboard mode<br>
                  <kbd>↑</kbd> / <kbd>k</kbd> Move up one row<br>
                  <kbd>↓</kbd> / <kbd>j</kbd> Move down one row<br>
                  <kbd>0-9</kbd> + <kbd>g</kbd> Go to row number<br>
                  <kbd>Ctrl+→</kbd> Next unreviewed string<br>
                  <kbd>Ctrl+←</kbd> Previous unreviewed string<br>
                  <kbd>Enter</kbd> Focus notes field<br>
                  <kbd>Esc</kbd> Exit keyboard mode<br><br>
            
                  <strong style="color: #28a745;">Review Actions:</strong><br>
                  <kbd>p</kbd> Mark current row as Pass<br>
                  <kbd>f</kbd> Mark current row as Fail<br>
                  <kbd>c</kbd> Clear current row state<br>
                </div>
                <div>
                  <strong style="color: #dc3545;">Quick Filters:</strong><br>
                  <kbd>P</kbd> Show only Passed entries<br>
                  <kbd>F</kbd> Show only Failed entries<br>
                  <kbd>U</kbd> Show only Unreviewed entries<br>
                  <kbd>A</kbd> Show All entries<br><br>
            
                  <strong style="color: #6c757d;">Other Shortcuts:</strong><br>
                  <kbd>Z</kbd> Enter Zen Mode<br>
                  <kbd>T</kbd> / <kbd>R</kbd> Toggle Raw/Formatted view<br>
                  <kbd>D</kbd> Toggle Dark/Light mode<br>
                  <kbd>?</kbd> Show this help<br><br>
            
                  <strong style="color: #ffc107;">Copy Feature:</strong><br>
                  <em>Click any text cell to copy content</em>
                </div>
              </div>
            </div>
            <div style="margin-top: 25px; text-align: center;">
              <button onclick="closeNormalHelp()" style="margin-right: 10px; padding: 8px 16px; 
                      background: #007bff; color: white; text-align: center; border: none; border-radius: 4px; cursor: pointer;">
                Got it!
              </button>
            </div>
          </div>
        `;

        $('body').append(helpHTML);
      }

      function closeNormalHelp() {
        normalHelpOpen = false;
        $('#normalHelp').remove();
      }

      // Zen Mode
      let zenMode = false; let zenCurrentIndex = 0;
      let zenShowingRaw = false;
      let zenHelpOpen = false;

      function showZenHelp() {
        zenHelpOpen = true;
        // For now remove the space from the help.
        // It's buggy, it jumps 2 strings instead of 1
        const helpHTML = `
          <div id="zenHelp" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                      background: var(--bg-secondary); padding: 30px; border-radius: 12px; 
                      z-index: 10002; max-width: 500px; border: 1px solid var(--border-color);
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="margin-top: 0; color: var(--text-primary);">Zen Mode Shortcuts</h3>
            <div style="color: var(--text-primary); line-height: 1.6;">
              <strong>Review:</strong> <kbd>p</kbd> Pass, <kbd>f</kbd> Fail, <kbd>c</kbd> Clear<br>
              <strong>Navigate:</strong> <kbd>→</kbd><kbd>←</kbd> or <kbd>h</kbd> <kbd>j</kbd> <kbd>k</kbd> <kbd>l</kbd> or <kbd>Space</kbd><br>
              <strong> Go To:</strong> <kbd>0-9</kbd> + <kbd>g</kbd> Jump to string number<br>
              <strong>Smart Nav:</strong> <kbd>Ctrl+→</kbd> Next unreviewed, <kbd>Ctrl+←</kbd> Prev unreviewed<br>
              <strong>Other:</strong> <kbd>Enter</kbd> Notes, <kbd>R</kbd> Raw toggle, <kbd>D</kbd> Dark mode<br>
              <strong>Exit:</strong> <kbd>Esc</kbd><br><br>
              <strong>Copy:</strong> Click on any text to copy raw content
            </div>
            <button onclick="closeZenHelp()" style="margin-top: 20px; padding: 8px 16px; 
                    background: #007bff; text-align: center; color: white; border: none; border-radius: 4px; cursor: pointer;">
              Got it!
            </button>
          </div>
        `;
  
        $('body').append(helpHTML);
      }

      function closeZenHelp() {
        zenHelpOpen = false;
        $('#zenHelp').remove();
      }

      function enterZenMode() {
        zenMode = true;
        showKeyboardHint()
        zenCurrentIndex = currentRowIndex || 0;
        
        const zenHTML = `
          <div class="zen-mode" id="zenMode">
            <button class="zen-exit" onclick="exitZenMode()">×</button>

            <div class="zen-container">
              <div class="zen-raw-indicator" id="zenRawIndicator">FORMATTED</div>
              <div class="zen-state-indicator" id="zenStateIndicator">Unreviewed</div>
              <div class="zen-feedback" id="zenFeedback">✓ Marked as Pass</div>
      
              <div class="zen-progress">String <span id="zenCurrent">1</span> of <span id="zenTotal">${tableData.length}</span></div>
              <div class="zen-progress-bar">
                <div class="zen-progress-fill" id="zenProgressFill"></div>
              </div>

              <div class="zen-string-id" id="zenStringId" onclick="zenCopyText(this, 'id')">STRING_ID</div>

              <div class="zen-text-pair">
                <div class="zen-source" id="zenSource" onclick="zenCopyText(this, 'source')">Source text here</div>
                <div class="zen-target" id="zenTarget" onclick="zenCopyText(this, 'target')">Target text here</div>
              </div>

              <div class="zen-actions">
                <button class="zen-btn zen-btn-nav" onclick="zenPrevious()">← Previous</button>
                <button class="zen-btn zen-btn-pass" onclick="zenMarkPass()">✓ Pass</button>
                <button class="zen-btn zen-btn-fail" onclick="zenMarkFail()">✗ Fail</button>
                <button class="zen-btn zen-btn-nav" onclick="zenNext()">Next →</button>
              </div>

              <input type="text" class="zen-notes" id="zenNotes" placeholder="Add your notes here..." maxlength="200">
            </div>
          </div>
        `;

        $('body').append(zenHTML);
        updateZenDisplay();

        // Remove any initial focus
        $('#zenMode').focus();

        // Save notes on input
        $('#zenNotes').on('input', function() {
          const notes = $(this).val();
          localStorage.setItem(getNotesKey(zenCurrentIndex), notes);
        }).on('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            $(this).blur();
          }
        });
      }

      function exitZenMode() {
        zenMode = false;
        $('#zenMode').fadeOut(200, function() {
          $(this).remove();
        });
      }

      function updateZenDisplay() {
        if (!zenMode) return;

        const currentData = tableData[zenCurrentIndex];
        const rawCurrentData = rawData[zenCurrentIndex];
        const progress = ((zenCurrentIndex + 1) / tableData.length) * 100;

        // Update progress
        $('#zenCurrent').text(zenCurrentIndex + 1);
        $('#zenProgressFill').css('width', progress + '%');

        const dataToShow = zenShowingRaw ? rawCurrentData : currentData;

        // const isChineseMode = headers.length >= 6 && headers.includes('CN') && headers.includes('CNTraditional');
        const isChineseMode = headers.includes('CN') && headers.includes('EN') && headers.length >= 6;
 
        // Update string ID
        $('#zenStringId').text(dataToShow[0]);

        if (isChineseMode) {
          // Chinese mode: Show CN, CNTraditional
          $('#zenSource').html(`<strong style="color: #007bff;">Source - ${headers[1]}</strong><br>
            ${dataToShow[1]}`);
          $('#zenTarget').html(`<strong style="color: #28a745;">Target - ${headers[3]}</strong><br>
            ${dataToShow[3]}`);
        } else {
          // Normal mode: Source & Target
          $('#zenSource').html(`<strong style="color: #007bff;">Source - ${headers[1]}</strong><br>
            ${dataToShow[1]}`);
          $('#zenTarget').html(`<strong style="color: #28a745;">Target - ${headers[2]}</strong><br>
            ${dataToShow[2]}`);
        }               

        const savedState = localStorage.getItem(getStateKey(zenCurrentIndex));
        const stateIndicator = $('#zenStateIndicator');

        if (savedState === 'Pass') {
          stateIndicator.text('✓ Pass').removeClass().addClass('zen-state-indicator zen-state-pass');
        } else if (savedState === 'Fail') {
          stateIndicator.text('✗ Fail').removeClass().addClass('zen-state-indicator zen-state-fail');
        } else {
          stateIndicator.text('Unreviewed').removeClass().addClass('zen-state-indicator zen-state-unreviewed');
        }

        // Update raw/formatted indicator
        const rawIndicator = $('#zenRawIndicator');
        if (zenShowingRaw) {
          rawIndicator.text('RAW').removeClass().addClass('zen-raw-indicator raw');
        } else {
          rawIndicator.text('FORMATTED').removeClass().addClass('zen-raw-indicator formatted');
        }

        const savedNotes = localStorage.getItem(getNotesKey(zenCurrentIndex));
        $('#zenNotes').val(savedNotes || '');
      }

      function zenNext() {
        if (zenCurrentIndex < tableData.length - 1) {
          zenCurrentIndex++;
          updateZenDisplay();
        }
      }

      function zenPrevious() {
        if (zenCurrentIndex > 0) {
          zenCurrentIndex--;
          updateZenDisplay();
        }
      }

      function zenMarkPass() {
        localStorage.setItem(getStateKey(zenCurrentIndex), 'Pass');
        updateMainTableRow(zenCurrentIndex, 'Pass');
        updateZenDisplay();
        setTimeout(() => zenNext(), 150);
      }

      function zenMarkFail() {
        localStorage.setItem(getStateKey(zenCurrentIndex), 'Fail');
        updateMainTableRow(zenCurrentIndex, 'Fail');
        updateZenDisplay();
        setTimeout(() => zenNext(), 150);
      }

      function zenNextUnreviewed() {
        for (let i = zenCurrentIndex + 1; i < tableData.length; i++) {
          const state = localStorage.getItem(getStateKey(i));
          if (!state || state === '') {
            zenCurrentIndex = i;
            updateZenDisplay();
            showZenFeedback('→ Next unreviewed', '#007bff');
            return;
          }
        }
        showZenFeedback('No more unreviewed');
      }

      function zenPreviousUnreviewed() {
        for (let i = zenCurrentIndex - 1; i >= 0; i--) {
          const state = localStorage.getItem(getStateKey(i));
          if (!state || state === '') {
            zenCurrentIndex = i;
            updateZenDisplay();
            showZenFeedback('← Prev unreviewed', '#007bff');
            return;
          }
        }
        showZenFeedback('No prev unreviewed', '#6c757d');
      }

      function showZenFeedback(message, color) {
        const feedback = $('#zenFeedback');
        feedback.text(message).css('background', color).addClass('show');
        setTimeout(() => feedback.removeClass('show'), 800);
      }

      function updateMainTableRow(rowIndex, state) {
        if (dataTable && dataTable.row(rowIndex).node()) {
          const row = $(dataTable.row(rowIndex).node());
          const select = row.find('.state-select');
          select.val(state).trigger('change');
        }
      }

      function zenToggleRaw() {
        zenShowingRaw = !zenShowingRaw;
        updateZenDisplay();
      }

      function zenCopyText(element, type) {
        const currentData = tableData[zenCurrentIndex];
        const rawCurrentData = rawData[zenCurrentIndex];

        // const isChineseMode = headers.length >= 6 && headers.includes('CN') && headers.includes('CNTraditional');
        const isChineseMode = headers.includes('CN') && headers.includes('EN') && headers.length >= 6;

        let textToCopy = '';

        switch(type) {
          case 'id':
            textToCopy = rawCurrentData[0]; // Always copy raw ID
            break;
          case 'source':
            if (isChineseMode) {
              // Chinese mode, copy only CN
              textToCopy = rawCurrentData[1];
            } else {
              textToCopy = rawCurrentData[1];
            }
            break;
          case 'target':
            if (isChineseMode) {
              textToCopy = rawCurrentData[3];
            } else {
              textToCopy = rawCurrentData[2];
            }
            break;
        }  

        // Decode HTML entities
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = textToCopy;
        const decodedText = tempDiv.textContent || tempDiv.innerText || textToCopy;

        navigator.clipboard.writeText(decodedText).then(() => {
          // Show copy feedback
          const feedback = document.createElement('div');
          feedback.className = 'copy-feedback show';
          feedback.textContent = 'Copied!';
          element.style.position = 'relative';
          element.appendChild(feedback);

          setTimeout(() => {
            feedback.classList.remove('show');
            setTimeout(() => {
              if (feedback.parentNode) {
                feedback.parentNode.removeChild(feedback);
              }
            }, 300);
          }, 1000);
        });
      }

      // Jump Jump
      function addToNumberBuffer(digit) {
        console.log('Adding digit:', digit, 'Current buffer:', numberBuffer);
        numberBuffer += digit;
        showNumberBuffer();
  
        if (numberInputTimeout) {
          clearTimeout(numberInputTimeout);
        }
  
        // Auto-clear after 3 seconds of no input
        numberInputTimeout = setTimeout(() => {
          clearNumberBuffer();
        }, 3000);
      }

      function showNumberBuffer() {
        $('.number-buffer-display').remove();
  
        if (numberBuffer === '') return;
  
        const totalCount = zenMode ? tableData.length : $('#myTable').DataTable().rows().count();
        const modeClass = zenMode ? 'zen' : 'normal';
  
        if (zenMode) {
          // Add to zen container
          $('#zenMode .zen-container').append(`
            <div class="number-buffer-display zen show">
              ${numberBuffer}
            </div>
          `);
        } else {
          // Add to body for normal mode
          $('body').append(`
            <div class="number-buffer-display normal show">
              ${numberBuffer} / ${totalCount}
            </div>
          `);
        }
      }

      function clearNumberBuffer() {
        numberBuffer = '';
        $('.number-buffer-display').fadeOut(200, function() {
          $(this).remove();
        });
  
        if (numberInputTimeout) {
          clearTimeout(numberInputTimeout);
          numberInputTimeout = null;
        }
      }

      function executeGoTo() {
        if (numberBuffer === '') return;
  
        const targetNumber = parseInt(numberBuffer);
  
        if (zenMode) {
          zenGoToString(targetNumber);
        } else {
          normalGoToRow(targetNumber);
          const actualRow = Math.min(targetNumber, $('#myTable').DataTable().rows().count());
        }
        clearNumberBuffer();
      }

      function zenGoToString(stringNumber) {
        const targetIndex = Math.min(stringNumber - 1, tableData.length - 1);

        if (targetIndex >= 0) {
          zenCurrentIndex = Math.max(0, targetIndex); // Ensure not negative
          updateZenDisplay();
          return true;
        }
        return false;
      }

      function normalGoToRow(rowNumber) {
        if (!isKeyboardMode) return false;

        const table = $('#myTable').DataTable();
        const totalRows = table.rows().count();

        const targetIndex = Math.min(rowNumber - 1, totalRows - 1);

        if (targetIndex >= 0) {
          currentRowIndex = Math.max(0, targetIndex); // Ensure not negative
          highlightCurrentRow();
          scrollToCurrentRow();
          return true;
        }
        return false;
      }

      // Function to handle dynamic CSS classes, due to Chinese mode case
      function applyColumnClasses() {
        const isChineseMode = headers.includes('CN') && headers.includes('EN') && headers.length >= 6;

        $('#myTable tbody tr').each(function() {
          const $row = $(this);
          const $cells = $row.find('td');

          // To avoid conflicts, remove any prior column classes
          $cells.removeClass('text-column occurrences-column state-column notes-column');

          if (isChineseMode) {
            // Chinese Mode: #, strId, CN, EN, CNTraditional, Occurrences, State, Notes
            $cells.eq(2).addClass('text-column'); // CN
            $cells.eq(3).addClass('text-column'); // EN
            $cells.eq(4).addClass('text-column'); // CNTraditional
            $cells.eq(5).addClass('occurrences-column');
            $cells.eq(6).addClass('state-column');
            $cells.eq(7).addClass('notes-column');
          } else {
            // Normal Mode: #, strId, EN, TargetLang, Occurrences, State, Notes
            $cells.eq(2).addClass('text-column'); // EN
            $cells.eq(3).addClass('text-column'); // TargetLang
            $cells.eq(4).addClass('occurrences-column'); // Occurrences
            $cells.eq(5).addClass('state-column'); // State
            $cells.eq(6).addClass('notes-column'); // Notes
          }
        });
      }
    </script>
  </body>
</html>