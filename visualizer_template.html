<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Zgame In-Game Testing 1.5.30 -Text Review_Italian</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <style>
      body {
                    font-family: Arial, sans-serif;
                }
                .toggle-btn {
                    position: fixed;
                    top: 10px;
                    left: 10px;
                    z-index: 9999;
                    padding: 8px 16px;
                    background-color: #007bff;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                }
                #clearState {
                    float: left;
                    margin-right: 10px;
                    margin-bottom: 10px;
                    padding: 5px 10px;
                    background-color: #dc3545;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                }
                .container {
                    padding-top: 60px;
                }
                #myTable td {
                    user-select: text !important;
                }
                select.state-select {
                    width: 100%;
                    font-weight: bold;
                }
                select.state-select.pass {
                    color: green;
                }
                select.state-select.fail {
                    color: red;
                }
    </style>
  </head>
  <body>
    <button class="toggle-btn" onclick="toggleData()">Visualize</button>
    <div class="container">
      <button id="clearState">Clear State</button>
      <table id="myTable" class="display" style="width:100%"></table>
    </div>
    <script>
      const headers = ["strId", "EN", "Italian", "State", "Token Check Result"];
        const rawData = [];
        const formattedData = [];
        let showingRaw = false;
        let tableData = formattedData;
        let dataTable;
    
        function getStateKey(index) {
            return "state_Zgame In-Game Testing 1.5.30 -Text Review_Italian_row_" + index;
        }
        
        function generateRowWithState(row, idx) {
            const savedState = localStorage.getItem(getStateKey(idx)) || "";
            const selectHTML = '<select class="state-select ' + savedState.toLowerCase() + '">' +
                '<option value="" ' + (savedState === "" ? "selected" : "") + '></option>' +
                '<option value="Pass" ' + (savedState === "Pass" ? "selected" : "") + '>Pass</option>' +
                '<option value="Fail" ' + (savedState === "Fail" ? "selected" : "") + '>Fail</option>' +
                '</select>';
            const newRow = row.slice();
            const stateIndex = headers.indexOf("State");
            newRow[stateIndex] = selectHTML;
            return newRow;
        }
    
        function renderData(data) {
            tableData = data;
            const transformed = data.map((row, idx) => generateRowWithState(row, idx));
    
            if (!dataTable) {
                dataTable = $('#myTable').DataTable({
                    data: transformed,
                    columns: headers.map(h => ({ title: h })),
                    scrollX: true,
                    paging: true,
                    searching: true,
                    ordering: false,
                    deferRender: true,
                    lengthMenu: [[-1, 10, 25, 50], ["All", 10, 25, 50]],
                    columnDefs: [
                        {
                            targets: headers.indexOf("State"),
                            orderable: true
                        }
                    ],
                    order: []
                });
    
                $('#myTable tbody').on('change', 'select.state-select', function () {
                    const rowIdx = dataTable.row($(this).closest('tr')).index();
                    const value = $(this).val();
                    localStorage.setItem(getStateKey(rowIdx), value);
                    this.className = "state-select " + value.toLowerCase();
                });
            } else {
                const currentPage = dataTable.page();
                const currentLength = dataTable.page.len();
                dataTable.clear().rows.add(transformed).draw(false);
                dataTable.page.len(currentLength).draw();
                dataTable.page(currentPage).draw(false);
            }
        }
    
        function toggleData() {
            showingRaw = !showingRaw;
            renderData(showingRaw ? rawData : formattedData);
        }
    
        function clearAllStates() {
            const total = tableData.length;
            for (let i = 0; i < total; i++) {
                localStorage.removeItem(getStateKey(i));
            }
            renderData(tableData);
        }
    
        $(document).ready(function () {
            renderData(formattedData);
            $('#clearState').click(clearAllStates);
        });
    </script>
  </body>
</html>